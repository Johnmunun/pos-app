import{r as l,j as e,H as K,L as Y,c as Z,a as b}from"./app-DZtTOeIE.js";import{A as ee,n as te,f as ae,s as q,o as re,C as M,b as se,e as le,t as D,u as A,g as de,h as ce,v as ne,m as ie}from"./AppLayout-Bwi93PbD.js";import{C as d,c,a as P,b as L}from"./card-vlabImcc.js";import{B as x}from"./Button-BTh3B2Uw.js";import{I as E}from"./Input--MgEb_Nf.js";import"./Label-CgyD4LXG.js";import{u as oe}from"./use-toast-DsB4X2cj.js";import{C as f}from"./x-CXs6YGQp.js";import{A as xe}from"./arrow-left-B06KhL06.js";import{C as me}from"./loader-circle-DAnXRmQH.js";import"./createLucideIcon-CC-qNPM4.js";import"./shield-x-BMsLrHBM.js";import"./user-cog-HidSeQFU.js";import"./Dropdown-BcljNwe3.js";import"./transition-DLc2G3IG.js";import"./refresh-cw-BgZ2dbVR.js";import"./FlashMessages-DVzYx1sH.js";const B={draft:{label:"Brouillon",color:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",icon:ie},in_progress:{label:"En cours",color:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",icon:me},validated:{label:"Validé",color:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",icon:f},cancelled:{label:"Annulé",color:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",icon:M}};function Pe({inventory:s,items:n,stats:ge,availableProducts:he=[],categories:V=[],permissions:j}){const{toast:y}=oe(),[m,H]=l.useState(""),[g,O]=l.useState(""),[N,Q]=l.useState(!1),[i,R]=l.useState(()=>{const t={};return n.forEach(a=>{t[a.product_id]=a.counted_quantity??""}),t}),[w,C]=l.useState(!1),[_,ue]=l.useState([]),h=j?.edit&&["draft","in_progress"].includes(s.status),U=j?.validate&&s.status==="in_progress",$=j?.cancel&&s.status!=="validated",k=s.status==="draft",S=l.useMemo(()=>n.filter(t=>{if(m){const a=m.toLowerCase();if(!t.product_name.toLowerCase().includes(a)&&!t.product_code.toLowerCase().includes(a))return!1}return!(g&&t.category_name!==g||N&&t.difference===0)}),[n,m,g,N]),o=l.useMemo(()=>{let t=0,a=0,r=0,v=0;return n.forEach(T=>{const u=i[T.product_id];if(u!==""&&u!==null&&u!==void 0){r++;const p=parseInt(u,10)-T.system_quantity;p>0?(t+=p,v++):p<0&&(a+=Math.abs(p),v++)}}),{total_items:n.length,counted_items:r,items_with_difference:v,total_positive:t,total_negative:a}},[n,i]),z=(t,a)=>{R(r=>({...r,[t]:a}))},F=async()=>{C(!0);try{const t=Object.entries(i).filter(([a,r])=>r!==""&&r!==null&&r!==void 0).map(([a,r])=>({product_id:a,counted_quantity:parseInt(r,10)}));if(t.length===0){y({title:"Attention",description:"Aucune quantité à sauvegarder.",variant:"warning"});return}await Z.post(route("pharmacy.inventories.counts",s.id),{counts:t}),y({title:"Succès",description:"Quantités sauvegardées avec succès."}),b.reload()}catch(t){y({title:"Erreur",description:t.response?.data?.message||"Erreur lors de la sauvegarde.",variant:"destructive"})}finally{C(!1)}},I=()=>{const t=_.length>0?_:null;b.post(route("pharmacy.inventories.start",s.id),{product_ids:t})},W=()=>{confirm("Êtes-vous sûr de vouloir valider cet inventaire ? Les ajustements de stock seront appliqués.")&&b.post(route("pharmacy.inventories.validate",s.id))},X=()=>{confirm("Êtes-vous sûr de vouloir annuler cet inventaire ?")&&b.post(route("pharmacy.inventories.cancel",s.id))},G=t=>{const a=i[t.product_id];if(a===""||a===null||a===void 0)return e.jsx(ne,{className:"h-4 w-4 text-gray-400"});const r=parseInt(a,10)-t.system_quantity;return r===0?e.jsx("span",{className:"text-gray-500",children:"0"}):r>0?e.jsxs("span",{className:"flex items-center text-green-600 dark:text-green-400 font-medium",children:[e.jsx(D,{className:"h-4 w-4 mr-1"}),"+",r]}):e.jsxs("span",{className:"flex items-center text-red-600 dark:text-red-400 font-medium",children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),r]})},J=t=>{const a=B[t]||B.draft,r=a.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium ${a.color}`,children:[e.jsx(r,{className:"h-4 w-4"}),a.label]})};return e.jsxs(ee,{header:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Y,{href:route("pharmacy.inventories.index"),className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors",children:e.jsx(xe,{className:"h-5 w-5 text-gray-600 dark:text-gray-300"})}),e.jsxs("h2",{className:"font-semibold text-xl text-gray-800 dark:text-gray-100 leading-tight",children:["Inventaire ",s.reference]})]}),children:[e.jsx(K,{title:`Inventaire ${s.reference}`}),e.jsx("div",{className:"py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:[e.jsx(d,{className:"mb-6 bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:s.reference}),J(s.status)]}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4"}),"Créé le ",s.created_at]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"h-4 w-4"}),"Par ",s.creator?.name??"Inconnu"]}),s.validated_at&&e.jsxs("span",{className:"flex items-center gap-1 text-green-600 dark:text-green-400",children:[e.jsx(f,{className:"h-4 w-4"}),"Validé le ",s.validated_at]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[k&&h&&e.jsxs(x,{onClick:I,className:"bg-blue-500 hover:bg-blue-600 text-white",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Démarrer"]}),h&&!k&&e.jsxs(x,{onClick:F,disabled:w,className:"bg-amber-500 hover:bg-amber-600 text-white",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),w?"Sauvegarde...":"Sauvegarder"]}),U&&e.jsxs(x,{onClick:W,className:"bg-green-500 hover:bg-green-600 text-white",children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Valider"]}),$&&e.jsxs(x,{onClick:X,variant:"outline",className:"border-red-300 text-red-600 hover:bg-red-50 dark:border-red-800 dark:text-red-400 dark:hover:bg-red-900/20",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Annuler"]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-6",children:[e.jsx(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(c,{className:"p-4 text-center",children:[e.jsx(se,{className:"h-6 w-6 text-blue-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:o.total_items}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Produits"})]})}),e.jsx(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(c,{className:"p-4 text-center",children:[e.jsx(f,{className:"h-6 w-6 text-green-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:o.counted_items}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Comptés"})]})}),e.jsx(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(c,{className:"p-4 text-center",children:[e.jsx(le,{className:"h-6 w-6 text-orange-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:o.items_with_difference}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Écarts"})]})}),e.jsx(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(c,{className:"p-4 text-center",children:[e.jsx(D,{className:"h-6 w-6 text-green-500 mx-auto mb-2"}),e.jsxs("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:["+",o.total_positive]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Surplus"})]})}),e.jsx(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(c,{className:"p-4 text-center",children:[e.jsx(A,{className:"h-6 w-6 text-red-500 mx-auto mb-2"}),e.jsxs("div",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:["-",o.total_negative]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Manquants"})]})})]}),k?e.jsxs(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:[e.jsx(P,{children:e.jsx(L,{className:"text-gray-900 dark:text-white",children:"Démarrer l'inventaire"})}),e.jsxs(c,{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:`Cliquez sur "Démarrer" pour créer le snapshot du stock actuel. Tous les produits actifs seront inclus dans l'inventaire.`}),h&&e.jsxs(x,{onClick:I,className:"bg-blue-500 hover:bg-blue-600 text-white",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Démarrer l'inventaire"]})]})]}):e.jsxs(d,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:[e.jsx(P,{children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs(L,{className:"flex items-center text-gray-900 dark:text-white",children:[e.jsx(de,{className:"h-5 w-5 mr-2 text-amber-500"}),"Produits à inventorier"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx(E,{placeholder:"Rechercher...",value:m,onChange:t=>H(t.target.value),className:"pl-9 w-48 bg-white dark:bg-slate-800 border-gray-300 dark:border-slate-600"})]}),e.jsxs("select",{value:g,onChange:t=>O(t.target.value),className:"h-10 rounded-md border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 px-3 focus:outline-none focus:ring-2 focus:ring-amber-500",children:[e.jsx("option",{value:"",children:"Toutes catégories"}),V.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:t=>Q(t.target.checked),className:"rounded border-gray-300 dark:border-slate-600 text-amber-500 focus:ring-amber-500"}),"Écarts uniquement"]})]})]})}),e.jsxs(c,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-slate-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-slate-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Produit"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Catégorie"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Stock système"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Qté comptée"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Écart"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700",children:S.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-slate-800",children:[e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.product_name}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.product_code})]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400",children:t.category_name||"-"}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.system_quantity})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:h?e.jsx(E,{type:"number",min:"0",value:i[t.product_id]??"",onChange:a=>z(t.product_id,a.target.value),className:"w-24 mx-auto text-center bg-white dark:bg-slate-800 border-gray-300 dark:border-slate-600",placeholder:"—"}):e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.counted_quantity??"—"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:G(t)})]},t.id))})]})}),S.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"Aucun produit ne correspond aux filtres"})]})]})]})})]})}export{Pe as default};
