import{u as Ge,r as s,j as e,H as Xe,L as Je,z as m,c as W,a as Ye}from"./app-B8F_Smya.js";import{A as Ze,S as ze,b as S,m as Ue,V as We,P as pe,X as et,d as tt,H as rt,Y as at,q as st,R as nt,Z as lt}from"./AppLayout-Cyrikcek.js";import{B as p}from"./Button-BSACjJaD.js";import{I as ee}from"./Input-DyZz_-qK.js";import{B as A}from"./badge-CezgjasG.js";import{g as it,f as ot}from"./currency-CAle3Gff.js";import{A as dt}from"./arrow-left-uFeYT1yE.js";import{T as ct}from"./user-cog-Cgo5DVwg.js";import{X as Le,b as xt,c as mt}from"./x-Ce9nIuKt.js";import"./createLucideIcon-NKf32Z79.js";import"./shield-x-CXAQmM6w.js";import"./Dropdown-CXpnj_1U.js";import"./transition-L_iZ831R.js";import"./loader-circle-5vrT9r4x.js";import"./refresh-cw-BeeT9s1l.js";import"./FlashMessages-CHIUDfR7.js";function ut({onClose:g,onCreated:te}){const[j,y]=s.useState(""),[z,re]=s.useState(""),[Q,L]=s.useState(!1),[M,i]=s.useState(""),H=async u=>{if(u.preventDefault(),i(""),!j.trim()){i("Nom requis");return}L(!0);try{const b=await W.post(route("pharmacy.sales.quick-customer"),{name:j.trim(),phone:z.trim()||null});b.data?.success&&b.data?.customer&&(m.success("Client créé"),te({id:String(b.data.customer.id),full_name:b.data.customer.full_name||j.trim(),phone:b.data.customer.phone||"",email:b.data.customer.email||""}))}catch(b){i(b.response?.data?.message||"Erreur")}finally{L(!1)}};return e.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/50",onClick:g,children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-xl w-full max-w-sm mx-4 p-6 shadow-xl",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Nouveau client"}),e.jsx("button",{type:"button",onClick:g,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200",children:e.jsx(Le,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Nom"}),e.jsx(ee,{type:"text",value:j,onChange:u=>y(u.target.value),placeholder:"Nom du client",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Téléphone"}),e.jsx(ee,{type:"text",value:z,onChange:u=>re(u.target.value),placeholder:"Optionnel",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),M&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:M}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(p,{type:"button",variant:"outline",onClick:g,className:"flex-1",children:"Annuler"}),e.jsx(p,{type:"submit",disabled:Q,className:"flex-1",children:"Créer"})]})]})]})})}function Et({products:g=[],categories:te=[],customers:j=[],canUseWholesale:y=!1,cashRegisters:z=[],currency:re,currencies:Q=[],exchangeRates:L={}}){const{shop:M}=Ge().props,i=(re??M?.currency??"CDF").toString().toUpperCase(),H=Q?.length?Q:M?.currencies??[],u=Object.keys(L||{}).length?L:{[i]:1},[b,Oe]=s.useState(i),q=b,N=(t,r)=>{if(t==null||t===0)return 0;const a=(r||i).toString().toUpperCase(),l=(q||i).toString().toUpperCase(),o=u[a]??u[i]??1,d=u[l]??1;return d===0?0:Number(t)*d/o},c=t=>ot(t,q),[ae,ye]=s.useState("thumbnails"),[P,se]=s.useState(""),[O,fe]=s.useState(null),[K,G]=s.useState(""),[n,f]=s.useState([]),[X,w]=s.useState(""),[I,J]=s.useState(!1),[$,ke]=s.useState([]),[je,ne]=s.useState(ce()),[le,E]=s.useState(!1),[ie,Ie]=s.useState("cash"),[v,Y]=s.useState({type:"percent",value:0}),[Z,gt]=s.useState(0),[h,Ne]=s.useState("retail"),[R,ve]=s.useState(0),[we,_e]=s.useState(null),[oe,de]=s.useState(!1),[$e,Ce]=s.useState(j),Se=s.useRef(null),Me=s.useRef(null),qe="pos_recent_product_ids",Fe=5;s.useEffect(()=>{Ce(j)},[j]),s.useEffect(()=>{Se.current?.focus()},[]),s.useEffect(()=>{const t=Math.min(R,Math.max(0,n.length-1));t!==R&&ve(t)},[n.length,R]);function ce(){return"A01-"+String(Math.floor(Math.random()*9e8)+1e8).padStart(10,"0")}const xe=s.useMemo(()=>{let t=g;if(O&&(t=t.filter(r=>r.category_id===O)),P.trim()){const r=P.toLowerCase();t=t.filter(a=>(a.name||"").toLowerCase().includes(r)||(a.code||"").toLowerCase().includes(r))}return t},[g,P,O]),F=t=>h==="wholesale"&&y&&t.wholesale_price_amount!=null?t.wholesale_price_amount:t.price_amount??0;s.useEffect(()=>{n.length!==0&&f(t=>t.map(r=>{const a=g.find(o=>o.id===r.product_id);if(!a)return r;const l=a.price_currency??i;return{...r,price:F(a),price_currency:l}}))},[h,i]);const[Pe,Be]=s.useState(()=>{try{const t=localStorage.getItem(qe);if(!t)return[];const r=JSON.parse(t);return Array.isArray(r)?r.slice(0,12):[]}catch{return[]}}),Ve=s.useCallback(t=>{try{Be(r=>{const a=[t,...r.filter(l=>l!==t)].slice(0,12);return localStorage.setItem(qe,JSON.stringify(a)),a})}catch{}},[]),B=t=>{const r=Number(t.stock)??0,a=!!(t.est_divisible??!0);if(r<(a?.01:1)){m.error("Stock insuffisant");return}const o=n.find(d=>d.product_id===t.id);if(o){if(o.quantity>=r){m.error("Stock insuffisant");return}f(n.map(d=>d.product_id===t.id?{...d,quantity:a?d.quantity+1:Math.min(d.quantity+1,Math.floor(r))}:d))}else{const d=t.price_currency??i;f([...n,{product_id:t.id,name:t.name,code:t.code,price:F(t),price_currency:d,quantity:1,max_stock:r,discount_percent:0,image_url:t.image_url,est_divisible:a,type_unite:t.type_unite??"UNITE"}])}Ve(t.id)},V=(t,r)=>{const a=Number(r);if(isNaN(a))return;const l=n.find(k=>k.product_id===t);if(!l)return;const o=!!(l.est_divisible??!0);if(a<(o?.01:1)){Ee(t);return}const be=l.max_stock??0;if(a>be){m.error("Stock insuffisant");return}const he=o?Math.round(a*1e4)/1e4:Math.max(1,Math.floor(a));f(n.map(k=>k.product_id===t?{...k,quantity:he}:k))},Ee=t=>{f(n.filter(r=>r.product_id!==t))},Re=()=>{f([]),Y({type:"percent",value:0}),ne(ce())},_=s.useMemo(()=>n.reduce((t,r)=>{const a=r.price*r.quantity,l=r.discount_percent?a*r.discount_percent/100:0,o=a-l;return t+N(o,r.price_currency??i)},0),[n,q,u,i]),me=s.useMemo(()=>_*Z/100,[_,Z]),U=s.useMemo(()=>v.type==="percent"?_*v.value/100:v.value,[_,v]),x=s.useMemo(()=>Math.max(0,_+me-U),[_,me,U]),D=Number(X)||0,ue=Math.max(0,x-D),ge=D>x?D-x:0,C=s.useMemo(()=>n.some(t=>t.quantity>(t.max_stock??0)),[n]),De=n.length>0&&!C;s.useEffect(()=>{if(le||oe)return;const t=r=>{const a=r.target;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.tagName==="SELECT"||a.isContentEditable)&&r.key!=="p"&&r.key!=="P")return;if(r.key==="p"||r.key==="P"){n.length>0&&!C&&(E(!0),r.preventDefault());return}if(n.length===0)return;const o=n[R];if(o){if(r.key==="+"||r.key==="=")V(o.product_id,o.quantity+1),r.preventDefault();else if(r.key==="-")V(o.product_id,o.quantity-1),r.preventDefault();else if(r.key==="d"||r.key==="D"){const d=prompt("Remise ligne (%) ?",String(o.discount_percent||0));if(d!==null){const be=Math.min(100,Math.max(0,parseFloat(d)||0));f(he=>he.map(k=>k.product_id===o.product_id?{...k,discount_percent:be}:k))}r.preventDefault()}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[le,oe,n,R,C]);const Te=s.useMemo(()=>{const t=H.filter(r=>r.code);return t.length>0?t:[{code:i,name:i,symbol:it(i)}]},[H,i]),T=s.useMemo(()=>{const t=(z||[]).filter(a=>a.open_session);if(t.length===0)return null;const r=t[0];return{cash_register_id:r.id,cash_register_session_id:r.open_session.id}},[z]),Qe=()=>{if(n.length===0){m.error("Panier vide");return}ke([...$,{orderNumber:je,cart:[...n],customerId:K,discount:v,timestamp:new Date}]),f([]),G(""),Y({type:"percent",value:0}),ne(ce()),m.success("Commande mise en attente")},He=t=>{const r=$[t];f(r.cart),G(r.customerId),Y(r.discount),ne(r.orderNumber),ke($.filter((a,l)=>l!==t))},Ae=async()=>{if(n.length===0){m.error("Panier vide. Ajoutez au moins un produit.");return}if(C){m.error("Stock négatif interdit. Ajustez les quantités.");return}J(!0);try{const r=(await W.post(route("pharmacy.sales.store"),{customer_id:K||null,currency:q,sale_mode:h,lines:n.map(l=>({product_id:l.product_id,quantity:l.quantity,unit_price:N(l.price,l.price_currency??i),discount_percent:l.discount_percent||null})),...T?{cash_register_id:T.cash_register_id,cash_register_session_id:T.cash_register_session_id}:{}})).data.sale.id;await W.post(route("pharmacy.sales.finalize",r),{paid_amount:X||x});const a=x;m.success("Vente finalisée avec succès!"),E(!1),Re(),w(""),_e({total:a}),setTimeout(()=>_e(null),2500),M?.receipt_auto_print&&window.open(route("pharmacy.sales.receipt",r),"_blank","noopener,noreferrer")}catch(t){m.error(t.response?.data?.message||"Erreur lors de la vente")}finally{J(!1)}},Ke=async()=>{if(n.length===0){m.error("Panier vide");return}J(!0);try{const t=await W.post(route("pharmacy.sales.store"),{customer_id:K||null,currency:q,sale_mode:h,lines:n.map(r=>({product_id:r.product_id,quantity:r.quantity,unit_price:N(r.price,r.price_currency??i),discount_percent:r.discount_percent||null})),...T?{cash_register_id:T.cash_register_id,cash_register_session_id:T.cash_register_session_id}:{}});m.success("Brouillon enregistré"),Ye.visit(route("pharmacy.sales.show",t.data.sale.id))}catch(t){m.error(t.response?.data?.message||"Erreur")}finally{J(!1)}};return e.jsxs(Ze,{children:[e.jsx(Xe,{title:"Point de Vente"}),e.jsxs("div",{className:"h-[calc(100vh-64px)] flex relative",children:[we&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-40 bg-green-600 dark:bg-green-700 text-white py-3 px-4 text-center shadow-lg animate-in fade-in duration-300",children:[e.jsx("p",{className:"text-lg font-semibold",children:"Vente enregistrée"}),e.jsx("p",{className:"text-2xl font-bold mt-0.5",children:c(we.total)})]}),e.jsxs("div",{className:"flex-1 flex flex-col bg-gray-50 dark:bg-slate-950",children:[e.jsx("div",{className:"p-4 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(p,{variant:"ghost",size:"sm",asChild:!0,className:"text-gray-600 dark:text-gray-300",children:e.jsxs(Je,{href:route("pharmacy.sales.index"),className:"inline-flex items-center gap-1.5",children:[e.jsx(dt,{className:"h-4 w-4 shrink-0"}),"Retour"]})}),Te.length>=1&&e.jsx("select",{value:q,onChange:t=>Oe(t.target.value),className:"h-9 rounded-md border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 text-sm font-medium px-3 min-w-[100px]",title:"Devise d'affichage (conversion selon le taux configuré)",children:Te.map(t=>e.jsxs("option",{value:t.code,children:[t.code," ",t.symbol&&t.symbol!==t.code?`(${t.symbol})`:""]},t.code))}),e.jsxs("div",{className:"flex items-center bg-amber-50 dark:bg-amber-900/20 rounded-lg p-1 border border-amber-200 dark:border-amber-800",title:h==="wholesale"&&!y?"Droits vente en gros requis":"",children:[e.jsxs("button",{type:"button",onClick:()=>Ne("retail"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${h==="retail"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"}`,children:[e.jsx(ze,{className:"h-4 w-4"}),"Détail"]}),e.jsxs("button",{type:"button",onClick:()=>y&&Ne("wholesale"),disabled:!y,className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${h==="wholesale"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"} ${y?"":"opacity-60 cursor-not-allowed"}`,title:y?"Vente en gros":"Droits vente en gros requis",children:[e.jsx(S,{className:"h-4 w-4"}),"Gros"]})]}),e.jsxs("div",{className:"flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>ye("list"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${ae==="list"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"List Item"}),e.jsx("button",{onClick:()=>ye("thumbnails"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${ae==="thumbnails"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"Thumbnails"})]}),e.jsxs("span",{className:"text-xs text-gray-400 dark:text-gray-500 whitespace-nowrap hidden sm:inline",children:["Raccourcis: ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"1"})," ventes · ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"2"})," ici · ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"P"})," paiement"]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ee,{ref:Se,type:"text",placeholder:"Recherche ou scan code-barres",value:P,onChange:t=>{const r=t.target.value;if(se(r),r.length>=6){const a=r.trim(),l=g.find(o=>(o.code||"").toLowerCase()===a.toLowerCase());l&&(B(l),se(""))}},onKeyDown:t=>{if(t.key==="Enter"&&P.trim().length>=6){const r=g.find(a=>(a.code||"").toLowerCase()===P.trim().toLowerCase());r&&(B(r),se(""),t.preventDefault())}},className:"pl-10 bg-gray-100 dark:bg-slate-800 border-0 text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400"})]}),e.jsx(p,{variant:"outline",size:"icon",className:"bg-blue-500 hover:bg-blue-600 text-white border-0",children:e.jsx(We,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"p-3 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700 overflow-x-auto",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>fe(null),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${O?"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700":"bg-amber-500 text-white"}`,children:"Tous"}),te.map(t=>e.jsx("button",{onClick:()=>fe(t.id),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${O===t.id?"bg-amber-500 text-white":"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700"}`,children:t.name},t.id))]})}),Pe.length>0&&e.jsxs("div",{className:"px-4 py-2 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Derniers produits"}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:Pe.map(t=>{const r=g.find(a=>a.id===t);return!r||(r.stock||0)<1?null:e.jsxs("button",{type:"button",onClick:()=>B(r),className:"flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-left hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors",children:[r.image_url?e.jsx("img",{src:r.image_url,alt:"",className:"w-8 h-8 rounded object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded bg-gray-200 dark:bg-slate-700 flex items-center justify-center",children:e.jsx(S,{className:"h-4 w-4 text-gray-400"})}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white max-w-[100px] truncate",children:r.name}),e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:c(N(F(r),r.price_currency??i))})]},t)})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[ae==="thumbnails"?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:xe.map(t=>e.jsxs("button",{onClick:()=>B(t),disabled:t.stock<1,className:`bg-white dark:bg-slate-800 rounded-xl p-3 text-center shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsxs("div",{className:"aspect-square mb-2 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover",onError:r=>{r.target.style.display="none",r.target.nextSibling.style.display="flex"}}):null,e.jsx("div",{className:`flex items-center justify-center ${t.image_url?"hidden":""}`,children:e.jsx(S,{className:"h-10 w-10 text-gray-400"})})]}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white line-clamp-2 mb-1",children:t.name}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:c(N(F(t),t.price_currency??i))}),t.stock>0&&t.stock<Fe&&e.jsx(A,{variant:"outline",className:"mt-1 text-xs text-orange-600 dark:text-orange-400 border-orange-300 dark:border-orange-600",children:"Rupture bientôt"}),t.stock<1&&e.jsx(A,{variant:"destructive",className:"mt-1 text-xs",children:"Rupture"})]},t.id))}):e.jsx("div",{className:"space-y-2",children:xe.map(t=>e.jsxs("button",{onClick:()=>B(t),disabled:t.stock<1,className:`w-full flex items-center gap-4 bg-white dark:bg-slate-800 rounded-lg p-3 shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsx("div",{className:"w-16 h-16 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx(S,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.code})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-amber-600 dark:text-amber-400",children:c(N(F(t),t.price_currency??i))}),y&&t.wholesale_price_amount!=null&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:h==="wholesale"?"Prix gros":`Gros: ${c(N(t.wholesale_price_amount,t.price_currency??i))}`}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Stock: ",t.stock]})]}),e.jsx(pe,{className:"h-5 w-5 text-amber-500"})]},t.id))}),xe.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx(S,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Aucun produit trouvé"})]})]})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-slate-900 border-l border-gray-200 dark:border-slate-700 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-slate-700",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(A,{className:h==="wholesale"?"bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300":"bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300",children:h==="wholesale"?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"h-3 w-3 mr-1 inline"})," Vente en gros"]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-3 w-3 mr-1 inline"})," Vente au détail"]})})}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(p,{variant:"outline",size:"sm",onClick:Qe,disabled:n.length===0,className:"text-gray-600 dark:text-gray-300",children:[e.jsx(et,{className:"h-4 w-4 mr-1"}),"Hold"]}),e.jsx(A,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-3 py-1",children:je}),e.jsxs(p,{variant:"outline",size:"sm",onClick:Re,className:"text-amber-600 border-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20",children:[e.jsx(pe,{className:"h-4 w-4 mr-1"}),"New"]})]}),$.length>0&&e.jsx("div",{className:"flex gap-2 overflow-x-auto py-2",children:$.map((t,r)=>e.jsxs("button",{onClick:()=>He(r),className:"flex-shrink-0 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 rounded-full text-xs font-medium hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors",children:[t.orderNumber.slice(-6)," (",t.cart.length,")"]},r))})]}),n.length>0&&e.jsxs("p",{className:"px-4 py-1 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-100 dark:border-slate-800",children:["Cliquez une ligne · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"+"}),e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono ml-0.5",children:"-"})," quantité · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"D"})," remise · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"P"})," paiement"]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:n.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(tt,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Panier vide"}),e.jsx("p",{className:"text-sm",children:"Ajoutez des produits"})]}):e.jsx("div",{className:"space-y-3",children:n.map((t,r)=>e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg border-2 transition-colors ${r===R?"bg-amber-50 dark:bg-amber-900/20 border-amber-400 dark:border-amber-500":"bg-gray-50 dark:bg-slate-800 border-transparent"}`,onClick:()=>ve(r),children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gray-200 dark:bg-slate-700 overflow-hidden flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(S,{className:"h-6 w-6 text-gray-400"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white text-sm truncate",children:t.name}),t.discount_percent>0&&e.jsxs(A,{className:"text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 border-0",children:["Promo -",t.discount_percent,"%"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{onClick:()=>V(t.product_id,t.est_divisible!==!1?t.quantity-.5:t.quantity-1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors text-gray-700 dark:text-gray-200",children:e.jsx(rt,{className:"h-3 w-3"})}),e.jsx("input",{type:"number",step:t.est_divisible!==!1?.5:1,min:t.est_divisible!==!1?.01:1,value:t.quantity,onChange:a=>{const l=parseFloat(a.target.value);Number.isNaN(l)||V(t.product_id,l)},className:"w-14 text-center rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 text-sm font-medium tabular-nums py-1",title:t.est_divisible!==!1?"Quantité (ex. 0.5 = demi-plaquette)":"Quantité entière uniquement"}),e.jsx("button",{onClick:()=>V(t.product_id,t.est_divisible!==!1?t.quantity+.5:t.quantity+1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors text-gray-700 dark:text-gray-200",children:e.jsx(pe,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:c(N(t.price*t.quantity,t.price_currency??i))}),e.jsx("button",{onClick:()=>Ee(t.product_id),className:"text-red-500 hover:text-red-600 mt-1",children:e.jsx(ct,{className:"h-4 w-4"})})]})]},t.product_id))})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-slate-700 p-4 space-y-3",children:[e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-blue-600 dark:text-blue-400 hover:underline",onClick:()=>{const t=prompt("Remise (%) ?",String(v.value));t!==null&&Y({type:"percent",value:parseFloat(t)||0})},children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(at,{className:"h-4 w-4"}),"Add Order Discount"]}),v.value>0&&e.jsxs(A,{className:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",children:[v.value,"%"]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Sous-total ",e.jsxs("span",{className:"text-xs",children:["(",n.length," articles)"]})]}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:c(_)})]}),Z>0&&e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Taxe (",Z,"% TVA incluse)"]}),e.jsx("span",{children:c(me)})]}),U>0&&e.jsxs("div",{className:"flex justify-between text-green-600 dark:text-green-400",children:[e.jsx("span",{children:"Remise"}),e.jsxs("span",{children:["-",c(U)]})]})]}),e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-gray-700 dark:text-gray-300 border-t border-gray-200 dark:border-slate-700",onClick:()=>E(!0),children:[e.jsx("span",{children:"Select payment mode"}),e.jsx(st,{className:"h-4 w-4"})]}),e.jsx("div",{className:"bg-blue-500 dark:bg-blue-600 rounded-xl p-4 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-medium",children:"Total"}),e.jsx("span",{className:"text-2xl font-bold",children:c(x)})]})}),C&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 font-medium",children:"Stock négatif interdit. Ajustez les quantités."}),e.jsxs(p,{onClick:()=>E(!0),disabled:n.length===0||I||C,className:"w-full bg-amber-500 hover:bg-amber-600 text-white py-6 text-lg font-semibold disabled:opacity-60",children:[e.jsx(nt,{className:"h-5 w-5 mr-2"}),I?"Traitement...":"Finaliser la vente"]})]})]})]}),le&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onKeyDown:t=>{t.key==="Escape"&&(E(!1),t.preventDefault()),t.key==="F2"&&(w(String(Math.round(x*100)/100)),setTimeout(()=>Me.current?.focus(),0),t.preventDefault()),t.key==="Enter"&&!t.target.closest("button")&&!t.target.closest("select")&&D>=x&&De&&(Ae(),t.preventDefault())},children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md mx-4 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white shrink-0",children:"Mode de paiement"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 hidden sm:inline",children:"Échap · F2 tout · Entrée valider"}),e.jsx("button",{onClick:()=>E(!1),className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 shrink-0",children:e.jsx(Le,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{id:"cash",icon:lt,label:"Espèces"},{id:"card",icon:xt,label:"Carte"},{id:"mobile",icon:mt,label:"Mobile"}].map(t=>e.jsxs("button",{onClick:()=>Ie(t.id),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${ie===t.id?"border-amber-500 bg-amber-50 dark:bg-amber-900/20":"border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600"}`,children:[e.jsx(t.icon,{className:`h-6 w-6 ${ie===t.id?"text-amber-500":"text-gray-400"}`}),e.jsx("span",{className:`text-sm font-medium ${ie===t.id?"text-amber-600 dark:text-amber-400":"text-gray-600 dark:text-gray-400"}`,children:t.label})]},t.id))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Montant reçu"}),e.jsx(ee,{ref:Me,type:"number",step:"0.01",min:0,value:X,onChange:t=>w(t.target.value),placeholder:x.toFixed(2),className:"text-2xl h-14 text-center font-semibold text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>w(String(Math.round(x*100)/100)),className:"py-2.5 px-3 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-sm font-medium text-amber-800 dark:text-amber-200 hover:bg-amber-200 dark:hover:bg-amber-900/50",children:"Montant exact"}),e.jsx("button",{type:"button",onClick:()=>w(String(Math.ceil(x/100)*100)),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"Arrondi 100"}),e.jsx("button",{type:"button",onClick:()=>w("50000"),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"50 000"}),e.jsx("button",{type:"button",onClick:()=>w("100000"),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"100 000"})]}),e.jsxs("div",{className:"rounded-xl p-4 min-h-[72px] flex flex-col justify-center",children:[ge>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Monnaie à rendre"}),e.jsx("p",{className:"text-3xl font-bold text-green-600 dark:text-green-400 mt-0.5",children:c(ge)})]}),ue>0&&D>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Reste à payer"}),e.jsx("p",{className:"text-3xl font-bold text-red-600 dark:text-red-400 mt-0.5",children:c(ue)})]}),ge<=0&&ue<=0&&D>=x&&x>0&&e.jsx("p",{className:"text-center text-lg font-semibold text-green-600 dark:text-green-400",children:"Montant OK"})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-slate-800 rounded-xl p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:c(x)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Reçu"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:c(Number(X)||0)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Client (optionnel)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{className:"flex-1 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white h-10 px-3",value:K,onChange:t=>G(t.target.value),children:[e.jsx("option",{value:"",children:"Sans client"}),$e.map(t=>e.jsx("option",{value:t.id,children:t.full_name},t.id))]}),e.jsx(p,{type:"button",variant:"outline",size:"sm",onClick:()=>de(!0),className:"shrink-0",title:"Créer un client",children:"+ Client"})]})]})]}),e.jsxs("div",{className:"p-6 bg-gray-50 dark:bg-slate-800 flex gap-3",children:[e.jsx(p,{variant:"outline",onClick:Ke,disabled:I||C,className:"flex-1",children:"Enregistrer brouillon"}),e.jsx(p,{onClick:Ae,disabled:I||!De,className:"flex-1 bg-amber-500 hover:bg-amber-600 text-white",children:I?"Traitement...":"Valider la vente"})]})]})}),oe&&e.jsx(ut,{onClose:()=>de(!1),onCreated:t=>{Ce(r=>[...r,t]),G(t.id),de(!1)}})]})}export{Et as default};
