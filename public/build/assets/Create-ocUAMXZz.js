import{u as Xe,r as s,j as e,H as Je,L as Ye,z as x,c as U,a as Ze}from"./app-Bu58nmqp.js";import{A as Qe,S as qe,b as _,i as Ue,V as We,P as he,X as et,d as tt,x as rt,Y as at,l as st,R as nt,Z as lt}from"./AppLayout-PYzm33Di.js";import{B as b}from"./Button-CJzVzbMf.js";import{I as W}from"./Input-B1xyFs7T.js";import{B as T}from"./badge-Dg1bczFZ.js";import{g as it,f as ot}from"./currency-CAle3Gff.js";import{A as dt}from"./arrow-left-DSvgm0i3.js";import{T as ct}from"./user-cog-DOLB-E56.js";import{X as Ae,b as xt,c as mt}from"./x-BNg5u3GU.js";import"./createLucideIcon-D31lZ7X_.js";import"./shield-x-Be2eaKBY.js";import"./Dropdown-BckUvWPZ.js";import"./transition-Dwpb1-fu.js";import"./loader-circle-BgO0_QPs.js";import"./refresh-cw-DMClxRp8.js";import"./FlashMessages-Ce1oH_d3.js";function ut({onClose:u,onCreated:ee}){const[f,p]=s.useState(""),[q,te]=s.useState(""),[V,A]=s.useState(!1),[C,l]=s.useState(""),B=async m=>{if(m.preventDefault(),l(""),!f.trim()){l("Nom requis");return}A(!0);try{const g=await U.post(route("pharmacy.sales.quick-customer"),{name:f.trim(),phone:q.trim()||null});g.data?.success&&g.data?.customer&&(x.success("Client créé"),ee({id:String(g.data.customer.id),full_name:g.data.customer.full_name||f.trim(),phone:g.data.customer.phone||"",email:g.data.customer.email||""}))}catch(g){l(g.response?.data?.message||"Erreur")}finally{A(!1)}};return e.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/50",onClick:u,children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-xl w-full max-w-sm mx-4 p-6 shadow-xl",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Nouveau client"}),e.jsx("button",{type:"button",onClick:u,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200",children:e.jsx(Ae,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Nom"}),e.jsx(W,{type:"text",value:f,onChange:m=>p(m.target.value),placeholder:"Nom du client",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Téléphone"}),e.jsx(W,{type:"text",value:q,onChange:m=>te(m.target.value),placeholder:"Optionnel",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),C&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:C}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(b,{type:"button",variant:"outline",onClick:u,className:"flex-1",children:"Annuler"}),e.jsx(b,{type:"submit",disabled:V,className:"flex-1",children:"Créer"})]})]})]})})}function Et({products:u=[],categories:ee=[],customers:f=[],canUseWholesale:p=!1,cashRegisters:q=[],currency:te,currencies:V=[],exchangeRates:A={}}){const{shop:C}=Xe().props,l=(te??C?.currency??"CDF").toString().toUpperCase(),B=V?.length?V:C?.currencies??[],m=Object.keys(A||{}).length?A:{[l]:1},[g,Le]=s.useState(l),S=g,k=(t,r)=>{if(t==null||t===0)return 0;const a=(r||l).toString().toUpperCase(),i=(S||l).toString().toUpperCase(),o=m[a]??m[l]??1,F=m[i]??1;return F===0?0:Number(t)*F/o},d=t=>ot(t,S),[re,be]=s.useState("thumbnails"),[M,ae]=s.useState(""),[L,pe]=s.useState(null),[H,K]=s.useState(""),[n,y]=s.useState([]),[G,N]=s.useState(""),[O,X]=s.useState(!1),[z,ye]=s.useState([]),[fe,se]=s.useState(de()),[ne,P]=s.useState(!1),[le,Oe]=s.useState("cash"),[j,J]=s.useState({type:"percent",value:0}),[Y,gt]=s.useState(0),[h,ke]=s.useState("retail"),[R,je]=s.useState(0),[Ne,ve]=s.useState(null),[ie,oe]=s.useState(!1),[ze,we]=s.useState(f),_e=s.useRef(null),Ce=s.useRef(null),Se="pos_recent_product_ids",$e=5;s.useEffect(()=>{we(f)},[f]),s.useEffect(()=>{_e.current?.focus()},[]),s.useEffect(()=>{const t=Math.min(R,Math.max(0,n.length-1));t!==R&&je(t)},[n.length,R]);function de(){return"A01-"+String(Math.floor(Math.random()*9e8)+1e8).padStart(10,"0")}const ce=s.useMemo(()=>{let t=u;if(L&&(t=t.filter(r=>r.category_id===L)),M.trim()){const r=M.toLowerCase();t=t.filter(a=>(a.name||"").toLowerCase().includes(r)||(a.code||"").toLowerCase().includes(r))}return t},[u,M,L]),$=t=>h==="wholesale"&&p&&t.wholesale_price_amount!=null?t.wholesale_price_amount:t.price_amount??0;s.useEffect(()=>{n.length!==0&&y(t=>t.map(r=>{const a=u.find(o=>o.id===r.product_id);if(!a)return r;const i=a.price_currency??l;return{...r,price:$(a),price_currency:i}}))},[h,l]);const[Me,Ie]=s.useState(()=>{try{const t=localStorage.getItem(Se);if(!t)return[];const r=JSON.parse(t);return Array.isArray(r)?r.slice(0,12):[]}catch{return[]}}),Fe=s.useCallback(t=>{try{Ie(r=>{const a=[t,...r.filter(i=>i!==t)].slice(0,12);return localStorage.setItem(Se,JSON.stringify(a)),a})}catch{}},[]),I=t=>{if((t.stock||0)<1){x.error("Stock insuffisant");return}const r=n.find(a=>a.product_id===t.id);if(r){if(r.quantity>=t.stock){x.error("Stock insuffisant");return}y(n.map(a=>a.product_id===t.id?{...a,quantity:a.quantity+1}:a))}else{const a=t.price_currency??l;y([...n,{product_id:t.id,name:t.name,code:t.code,price:$(t),price_currency:a,quantity:1,max_stock:t.stock,discount_percent:0,image_url:t.image_url}])}Fe(t.id)},Z=(t,r)=>{if(r<1){Pe(t);return}const a=n.find(i=>i.product_id===t);if(a&&r>a.max_stock){x.error("Stock insuffisant");return}y(n.map(i=>i.product_id===t?{...i,quantity:r}:i))},Pe=t=>{y(n.filter(r=>r.product_id!==t))},Re=()=>{y([]),J({type:"percent",value:0}),se(de())},v=s.useMemo(()=>n.reduce((t,r)=>{const a=r.price*r.quantity,i=r.discount_percent?a*r.discount_percent/100:0,o=a-i;return t+k(o,r.price_currency??l)},0),[n,S,m,l]),xe=s.useMemo(()=>v*Y/100,[v,Y]),Q=s.useMemo(()=>j.type==="percent"?v*j.value/100:j.value,[v,j]),c=s.useMemo(()=>Math.max(0,v+xe-Q),[v,xe,Q]),E=Number(G)||0,me=Math.max(0,c-E),ue=E>c?E-c:0,w=s.useMemo(()=>n.some(t=>t.quantity>(t.max_stock??0)),[n]),Ee=n.length>0&&!w;s.useEffect(()=>{if(ne||ie)return;const t=r=>{const a=r.target;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.tagName==="SELECT"||a.isContentEditable)&&r.key!=="p"&&r.key!=="P")return;if(r.key==="p"||r.key==="P"){n.length>0&&!w&&(P(!0),r.preventDefault());return}if(n.length===0)return;const o=n[R];if(o){if(r.key==="+"||r.key==="=")Z(o.product_id,o.quantity+1),r.preventDefault();else if(r.key==="-")Z(o.product_id,o.quantity-1),r.preventDefault();else if(r.key==="d"||r.key==="D"){const F=prompt("Remise ligne (%) ?",String(o.discount_percent||0));if(F!==null){const Ke=Math.min(100,Math.max(0,parseFloat(F)||0));y(Ge=>Ge.map(ge=>ge.product_id===o.product_id?{...ge,discount_percent:Ke}:ge))}r.preventDefault()}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ne,ie,n,R,w]);const De=s.useMemo(()=>{const t=B.filter(r=>r.code);return t.length>0?t:[{code:l,name:l,symbol:it(l)}]},[B,l]),D=s.useMemo(()=>{const t=(q||[]).filter(a=>a.open_session);if(t.length===0)return null;const r=t[0];return{cash_register_id:r.id,cash_register_session_id:r.open_session.id}},[q]),Ve=()=>{if(n.length===0){x.error("Panier vide");return}ye([...z,{orderNumber:fe,cart:[...n],customerId:H,discount:j,timestamp:new Date}]),y([]),K(""),J({type:"percent",value:0}),se(de()),x.success("Commande mise en attente")},Be=t=>{const r=z[t];y(r.cart),K(r.customerId),J(r.discount),se(r.orderNumber),ye(z.filter((a,i)=>i!==t))},Te=async()=>{if(n.length===0){x.error("Panier vide. Ajoutez au moins un produit.");return}if(w){x.error("Stock négatif interdit. Ajustez les quantités.");return}X(!0);try{const r=(await U.post(route("pharmacy.sales.store"),{customer_id:H||null,currency:S,sale_mode:h,lines:n.map(i=>({product_id:i.product_id,quantity:i.quantity,unit_price:k(i.price,i.price_currency??l),discount_percent:i.discount_percent||null})),...D?{cash_register_id:D.cash_register_id,cash_register_session_id:D.cash_register_session_id}:{}})).data.sale.id;await U.post(route("pharmacy.sales.finalize",r),{paid_amount:G||c});const a=c;x.success("Vente finalisée avec succès!"),P(!1),Re(),N(""),ve({total:a}),setTimeout(()=>ve(null),2500),C?.receipt_auto_print&&window.open(route("pharmacy.sales.receipt",r),"_blank","noopener,noreferrer")}catch(t){x.error(t.response?.data?.message||"Erreur lors de la vente")}finally{X(!1)}},He=async()=>{if(n.length===0){x.error("Panier vide");return}X(!0);try{const t=await U.post(route("pharmacy.sales.store"),{customer_id:H||null,currency:S,sale_mode:h,lines:n.map(r=>({product_id:r.product_id,quantity:r.quantity,unit_price:k(r.price,r.price_currency??l),discount_percent:r.discount_percent||null})),...D?{cash_register_id:D.cash_register_id,cash_register_session_id:D.cash_register_session_id}:{}});x.success("Brouillon enregistré"),Ze.visit(route("pharmacy.sales.show",t.data.sale.id))}catch(t){x.error(t.response?.data?.message||"Erreur")}finally{X(!1)}};return e.jsxs(Qe,{children:[e.jsx(Je,{title:"Point de Vente"}),e.jsxs("div",{className:"h-[calc(100vh-64px)] flex relative",children:[Ne&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-40 bg-green-600 dark:bg-green-700 text-white py-3 px-4 text-center shadow-lg animate-in fade-in duration-300",children:[e.jsx("p",{className:"text-lg font-semibold",children:"Vente enregistrée"}),e.jsx("p",{className:"text-2xl font-bold mt-0.5",children:d(Ne.total)})]}),e.jsxs("div",{className:"flex-1 flex flex-col bg-gray-50 dark:bg-slate-950",children:[e.jsx("div",{className:"p-4 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(b,{variant:"ghost",size:"sm",asChild:!0,className:"text-gray-600 dark:text-gray-300",children:e.jsxs(Ye,{href:route("pharmacy.sales.index"),className:"inline-flex items-center gap-1.5",children:[e.jsx(dt,{className:"h-4 w-4 shrink-0"}),"Retour"]})}),De.length>=1&&e.jsx("select",{value:S,onChange:t=>Le(t.target.value),className:"h-9 rounded-md border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 text-sm font-medium px-3 min-w-[100px]",title:"Devise d'affichage (conversion selon le taux configuré)",children:De.map(t=>e.jsxs("option",{value:t.code,children:[t.code," ",t.symbol&&t.symbol!==t.code?`(${t.symbol})`:""]},t.code))}),e.jsxs("div",{className:"flex items-center bg-amber-50 dark:bg-amber-900/20 rounded-lg p-1 border border-amber-200 dark:border-amber-800",title:h==="wholesale"&&!p?"Droits vente en gros requis":"",children:[e.jsxs("button",{type:"button",onClick:()=>ke("retail"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${h==="retail"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"}`,children:[e.jsx(qe,{className:"h-4 w-4"}),"Détail"]}),e.jsxs("button",{type:"button",onClick:()=>p&&ke("wholesale"),disabled:!p,className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${h==="wholesale"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"} ${p?"":"opacity-60 cursor-not-allowed"}`,title:p?"Vente en gros":"Droits vente en gros requis",children:[e.jsx(_,{className:"h-4 w-4"}),"Gros"]})]}),e.jsxs("div",{className:"flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>be("list"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${re==="list"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"List Item"}),e.jsx("button",{onClick:()=>be("thumbnails"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${re==="thumbnails"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"Thumbnails"})]}),e.jsxs("span",{className:"text-xs text-gray-400 dark:text-gray-500 whitespace-nowrap hidden sm:inline",children:["Raccourcis: ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"1"})," ventes · ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"2"})," ici · ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"P"})," paiement"]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(W,{ref:_e,type:"text",placeholder:"Recherche ou scan code-barres",value:M,onChange:t=>{const r=t.target.value;if(ae(r),r.length>=6){const a=r.trim(),i=u.find(o=>(o.code||"").toLowerCase()===a.toLowerCase());i&&(I(i),ae(""))}},onKeyDown:t=>{if(t.key==="Enter"&&M.trim().length>=6){const r=u.find(a=>(a.code||"").toLowerCase()===M.trim().toLowerCase());r&&(I(r),ae(""),t.preventDefault())}},className:"pl-10 bg-gray-100 dark:bg-slate-800 border-0 text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400"})]}),e.jsx(b,{variant:"outline",size:"icon",className:"bg-blue-500 hover:bg-blue-600 text-white border-0",children:e.jsx(We,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"p-3 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700 overflow-x-auto",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>pe(null),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${L?"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700":"bg-amber-500 text-white"}`,children:"Tous"}),ee.map(t=>e.jsx("button",{onClick:()=>pe(t.id),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${L===t.id?"bg-amber-500 text-white":"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700"}`,children:t.name},t.id))]})}),Me.length>0&&e.jsxs("div",{className:"px-4 py-2 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Derniers produits"}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:Me.map(t=>{const r=u.find(a=>a.id===t);return!r||(r.stock||0)<1?null:e.jsxs("button",{type:"button",onClick:()=>I(r),className:"flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-left hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors",children:[r.image_url?e.jsx("img",{src:r.image_url,alt:"",className:"w-8 h-8 rounded object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded bg-gray-200 dark:bg-slate-700 flex items-center justify-center",children:e.jsx(_,{className:"h-4 w-4 text-gray-400"})}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white max-w-[100px] truncate",children:r.name}),e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:d(k($(r),r.price_currency??l))})]},t)})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[re==="thumbnails"?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:ce.map(t=>e.jsxs("button",{onClick:()=>I(t),disabled:t.stock<1,className:`bg-white dark:bg-slate-800 rounded-xl p-3 text-center shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsxs("div",{className:"aspect-square mb-2 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover",onError:r=>{r.target.style.display="none",r.target.nextSibling.style.display="flex"}}):null,e.jsx("div",{className:`flex items-center justify-center ${t.image_url?"hidden":""}`,children:e.jsx(_,{className:"h-10 w-10 text-gray-400"})})]}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white line-clamp-2 mb-1",children:t.name}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:d(k($(t),t.price_currency??l))}),t.stock>0&&t.stock<$e&&e.jsx(T,{variant:"outline",className:"mt-1 text-xs text-orange-600 dark:text-orange-400 border-orange-300 dark:border-orange-600",children:"Rupture bientôt"}),t.stock<1&&e.jsx(T,{variant:"destructive",className:"mt-1 text-xs",children:"Rupture"})]},t.id))}):e.jsx("div",{className:"space-y-2",children:ce.map(t=>e.jsxs("button",{onClick:()=>I(t),disabled:t.stock<1,className:`w-full flex items-center gap-4 bg-white dark:bg-slate-800 rounded-lg p-3 shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsx("div",{className:"w-16 h-16 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx(_,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.code})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-amber-600 dark:text-amber-400",children:d(k($(t),t.price_currency??l))}),p&&t.wholesale_price_amount!=null&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:h==="wholesale"?"Prix gros":`Gros: ${d(k(t.wholesale_price_amount,t.price_currency??l))}`}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Stock: ",t.stock]})]}),e.jsx(he,{className:"h-5 w-5 text-amber-500"})]},t.id))}),ce.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx(_,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Aucun produit trouvé"})]})]})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-slate-900 border-l border-gray-200 dark:border-slate-700 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-slate-700",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(T,{className:h==="wholesale"?"bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300":"bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300",children:h==="wholesale"?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-3 w-3 mr-1 inline"})," Vente en gros"]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"h-3 w-3 mr-1 inline"})," Vente au détail"]})})}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:Ve,disabled:n.length===0,className:"text-gray-600 dark:text-gray-300",children:[e.jsx(et,{className:"h-4 w-4 mr-1"}),"Hold"]}),e.jsx(T,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-3 py-1",children:fe}),e.jsxs(b,{variant:"outline",size:"sm",onClick:Re,className:"text-amber-600 border-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20",children:[e.jsx(he,{className:"h-4 w-4 mr-1"}),"New"]})]}),z.length>0&&e.jsx("div",{className:"flex gap-2 overflow-x-auto py-2",children:z.map((t,r)=>e.jsxs("button",{onClick:()=>Be(r),className:"flex-shrink-0 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 rounded-full text-xs font-medium hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors",children:[t.orderNumber.slice(-6)," (",t.cart.length,")"]},r))})]}),n.length>0&&e.jsxs("p",{className:"px-4 py-1 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-100 dark:border-slate-800",children:["Cliquez une ligne · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"+"}),e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono ml-0.5",children:"-"})," quantité · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"D"})," remise · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"P"})," paiement"]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:n.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(tt,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Panier vide"}),e.jsx("p",{className:"text-sm",children:"Ajoutez des produits"})]}):e.jsx("div",{className:"space-y-3",children:n.map((t,r)=>e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg border-2 transition-colors ${r===R?"bg-amber-50 dark:bg-amber-900/20 border-amber-400 dark:border-amber-500":"bg-gray-50 dark:bg-slate-800 border-transparent"}`,onClick:()=>je(r),children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gray-200 dark:bg-slate-700 overflow-hidden flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(_,{className:"h-6 w-6 text-gray-400"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white text-sm truncate",children:t.name}),t.discount_percent>0&&e.jsxs(T,{className:"text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 border-0",children:["Promo -",t.discount_percent,"%"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{onClick:()=>Z(t.product_id,t.quantity-1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors text-gray-700 dark:text-gray-200",children:e.jsx(rt,{className:"h-3 w-3"})}),e.jsx("span",{className:"w-8 text-center font-medium text-sm text-gray-900 dark:text-gray-100 tabular-nums",children:t.quantity}),e.jsx("button",{onClick:()=>Z(t.product_id,t.quantity+1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors text-gray-700 dark:text-gray-200",children:e.jsx(he,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:d(k(t.price*t.quantity,t.price_currency??l))}),e.jsx("button",{onClick:()=>Pe(t.product_id),className:"text-red-500 hover:text-red-600 mt-1",children:e.jsx(ct,{className:"h-4 w-4"})})]})]},t.product_id))})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-slate-700 p-4 space-y-3",children:[e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-blue-600 dark:text-blue-400 hover:underline",onClick:()=>{const t=prompt("Remise (%) ?",String(j.value));t!==null&&J({type:"percent",value:parseFloat(t)||0})},children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(at,{className:"h-4 w-4"}),"Add Order Discount"]}),j.value>0&&e.jsxs(T,{className:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",children:[j.value,"%"]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Sous-total ",e.jsxs("span",{className:"text-xs",children:["(",n.length," articles)"]})]}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:d(v)})]}),Y>0&&e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Taxe (",Y,"% TVA incluse)"]}),e.jsx("span",{children:d(xe)})]}),Q>0&&e.jsxs("div",{className:"flex justify-between text-green-600 dark:text-green-400",children:[e.jsx("span",{children:"Remise"}),e.jsxs("span",{children:["-",d(Q)]})]})]}),e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-gray-700 dark:text-gray-300 border-t border-gray-200 dark:border-slate-700",onClick:()=>P(!0),children:[e.jsx("span",{children:"Select payment mode"}),e.jsx(st,{className:"h-4 w-4"})]}),e.jsx("div",{className:"bg-blue-500 dark:bg-blue-600 rounded-xl p-4 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-medium",children:"Total"}),e.jsx("span",{className:"text-2xl font-bold",children:d(c)})]})}),w&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 font-medium",children:"Stock négatif interdit. Ajustez les quantités."}),e.jsxs(b,{onClick:()=>P(!0),disabled:n.length===0||O||w,className:"w-full bg-amber-500 hover:bg-amber-600 text-white py-6 text-lg font-semibold disabled:opacity-60",children:[e.jsx(nt,{className:"h-5 w-5 mr-2"}),O?"Traitement...":"Finaliser la vente"]})]})]})]}),ne&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onKeyDown:t=>{t.key==="Escape"&&(P(!1),t.preventDefault()),t.key==="F2"&&(N(String(Math.round(c*100)/100)),setTimeout(()=>Ce.current?.focus(),0),t.preventDefault()),t.key==="Enter"&&!t.target.closest("button")&&!t.target.closest("select")&&E>=c&&Ee&&(Te(),t.preventDefault())},children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md mx-4 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white shrink-0",children:"Mode de paiement"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 hidden sm:inline",children:"Échap · F2 tout · Entrée valider"}),e.jsx("button",{onClick:()=>P(!1),className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 shrink-0",children:e.jsx(Ae,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{id:"cash",icon:lt,label:"Espèces"},{id:"card",icon:xt,label:"Carte"},{id:"mobile",icon:mt,label:"Mobile"}].map(t=>e.jsxs("button",{onClick:()=>Oe(t.id),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${le===t.id?"border-amber-500 bg-amber-50 dark:bg-amber-900/20":"border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600"}`,children:[e.jsx(t.icon,{className:`h-6 w-6 ${le===t.id?"text-amber-500":"text-gray-400"}`}),e.jsx("span",{className:`text-sm font-medium ${le===t.id?"text-amber-600 dark:text-amber-400":"text-gray-600 dark:text-gray-400"}`,children:t.label})]},t.id))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Montant reçu"}),e.jsx(W,{ref:Ce,type:"number",step:"0.01",min:0,value:G,onChange:t=>N(t.target.value),placeholder:c.toFixed(2),className:"text-2xl h-14 text-center font-semibold text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>N(String(Math.round(c*100)/100)),className:"py-2.5 px-3 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-sm font-medium text-amber-800 dark:text-amber-200 hover:bg-amber-200 dark:hover:bg-amber-900/50",children:"Montant exact"}),e.jsx("button",{type:"button",onClick:()=>N(String(Math.ceil(c/100)*100)),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"Arrondi 100"}),e.jsx("button",{type:"button",onClick:()=>N("50000"),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"50 000"}),e.jsx("button",{type:"button",onClick:()=>N("100000"),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"100 000"})]}),e.jsxs("div",{className:"rounded-xl p-4 min-h-[72px] flex flex-col justify-center",children:[ue>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Monnaie à rendre"}),e.jsx("p",{className:"text-3xl font-bold text-green-600 dark:text-green-400 mt-0.5",children:d(ue)})]}),me>0&&E>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Reste à payer"}),e.jsx("p",{className:"text-3xl font-bold text-red-600 dark:text-red-400 mt-0.5",children:d(me)})]}),ue<=0&&me<=0&&E>=c&&c>0&&e.jsx("p",{className:"text-center text-lg font-semibold text-green-600 dark:text-green-400",children:"Montant OK"})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-slate-800 rounded-xl p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:d(c)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Reçu"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:d(Number(G)||0)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Client (optionnel)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{className:"flex-1 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white h-10 px-3",value:H,onChange:t=>K(t.target.value),children:[e.jsx("option",{value:"",children:"Sans client"}),ze.map(t=>e.jsx("option",{value:t.id,children:t.full_name},t.id))]}),e.jsx(b,{type:"button",variant:"outline",size:"sm",onClick:()=>oe(!0),className:"shrink-0",title:"Créer un client",children:"+ Client"})]})]})]}),e.jsxs("div",{className:"p-6 bg-gray-50 dark:bg-slate-800 flex gap-3",children:[e.jsx(b,{variant:"outline",onClick:He,disabled:O||w,className:"flex-1",children:"Enregistrer brouillon"}),e.jsx(b,{onClick:Te,disabled:O||!Ee,className:"flex-1 bg-amber-500 hover:bg-amber-600 text-white",children:O?"Traitement...":"Valider la vente"})]})]})}),ie&&e.jsx(ut,{onClose:()=>oe(!1),onCreated:t=>{we(r=>[...r,t]),K(t.id),oe(!1)}})]})}export{Et as default};
