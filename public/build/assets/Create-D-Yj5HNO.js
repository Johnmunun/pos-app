import{u as xe,r as l,j as e,H as me,L as ue,z as o,c as F,a as he}from"./app-DZtTOeIE.js";import{A as ge,S as be,b as p,h as fe,G as pe,P as I,z as ye,d as je,v as ke,I as Ne,k as ve,R as we,J as _e}from"./AppLayout-Bwi93PbD.js";import{B as u}from"./Button-BTh3B2Uw.js";import{I as ee}from"./Input--MgEb_Nf.js";import{B as q}from"./badge-BDQ0rHun.js";import{f as Ce}from"./currency-C0RJmSMb.js";import{A as Se}from"./arrow-left-B06KhL06.js";import{T as Me}from"./user-cog-HidSeQFU.js";import{X as Pe,b as qe,c as Re}from"./x-CXs6YGQp.js";import"./createLucideIcon-CC-qNPM4.js";import"./shield-x-BMsLrHBM.js";import"./Dropdown-BcljNwe3.js";import"./transition-DLc2G3IG.js";import"./loader-circle-DAnXRmQH.js";import"./refresh-cw-BgZ2dbVR.js";import"./FlashMessages-DVzYx1sH.js";function Ye({products:R=[],categories:te=[],customers:se=[],canUseWholesale:A=!1}){const{shop:ae}=xe().props,y=ae?.currency||"CDF",n=t=>Ce(t,y),[T,H]=l.useState("thumbnails"),[j,re]=l.useState(""),[h,V]=l.useState(null),[k,$]=l.useState(""),[r,c]=l.useState([]),[N,z]=l.useState(""),[g,v]=l.useState(!1),[b,G]=l.useState([]),[J,D]=l.useState(E()),[le,w]=l.useState(!1),[O,ne]=l.useState("cash"),[x,_]=l.useState({type:"percent",value:0}),[C,Ae]=l.useState(0),[f,X]=l.useState("retail");function E(){return"A01-"+String(Math.floor(Math.random()*9e8)+1e8).padStart(10,"0")}const L=l.useMemo(()=>{let t=R;if(h&&(t=t.filter(s=>s.category_id===h)),j.trim()){const s=j.toLowerCase();t=t.filter(a=>(a.name||"").toLowerCase().includes(s)||(a.code||"").toLowerCase().includes(s))}return t},[R,j,h]),S=t=>f==="wholesale"&&A&&t.wholesale_price_amount!=null?t.wholesale_price_amount:t.price_amount??0;l.useEffect(()=>{r.length!==0&&c(t=>t.map(s=>{const a=R.find(d=>d.id===s.product_id);return a?{...s,price:S(a)}:s}))},[f]);const K=t=>{if((t.stock||0)<1){o.error("Stock insuffisant");return}const s=r.find(a=>a.product_id===t.id);if(s){if(s.quantity>=t.stock){o.error("Stock insuffisant");return}c(r.map(a=>a.product_id===t.id?{...a,quantity:a.quantity+1}:a))}else c([...r,{product_id:t.id,name:t.name,code:t.code,price:S(t),currency:y,quantity:1,max_stock:t.stock,discount_percent:0,image_url:t.image_url}])},Y=(t,s)=>{if(s<1){Z(t);return}const a=r.find(d=>d.product_id===t);if(a&&s>a.max_stock){o.error("Stock insuffisant");return}c(r.map(d=>d.product_id===t?{...d,quantity:s}:d))},Z=t=>{c(r.filter(s=>s.product_id!==t))},Q=()=>{c([]),_({type:"percent",value:0}),D(E())},m=l.useMemo(()=>r.reduce((t,s)=>{const a=s.price*s.quantity,d=s.discount_percent?a*s.discount_percent/100:0;return t+(a-d)},0),[r]),B=l.useMemo(()=>m*C/100,[m,C]),M=l.useMemo(()=>x.type==="percent"?m*x.value/100:x.value,[m,x]),i=l.useMemo(()=>Math.max(0,m+B-M),[m,B,M]),P=Number(N)||0,U=Math.max(0,i-P),W=P>i?P-i:0,ie=()=>{if(r.length===0){o.error("Panier vide");return}G([...b,{orderNumber:J,cart:[...r],customerId:k,discount:x,timestamp:new Date}]),c([]),$(""),_({type:"percent",value:0}),D(E()),o.success("Commande mise en attente")},de=t=>{const s=b[t];c(s.cart),$(s.customerId),_(s.discount),D(s.orderNumber),G(b.filter((a,d)=>d!==t))},oe=async()=>{if(r.length===0){o.error("Panier vide. Ajoutez au moins un produit.");return}v(!0);try{const s=(await F.post(route("pharmacy.sales.store"),{customer_id:k||null,currency:y,lines:r.map(a=>({product_id:a.product_id,quantity:a.quantity,unit_price:a.price,discount_percent:a.discount_percent||null}))})).data.sale.id;await F.post(route("pharmacy.sales.finalize",s),{paid_amount:N||i}),o.success("Vente finalisée avec succès!"),w(!1),Q(),z("")}catch(t){o.error(t.response?.data?.message||"Erreur lors de la vente")}finally{v(!1)}},ce=async()=>{if(r.length===0){o.error("Panier vide");return}v(!0);try{const t=await F.post(route("pharmacy.sales.store"),{customer_id:k||null,currency:y,lines:r.map(s=>({product_id:s.product_id,quantity:s.quantity,unit_price:s.price,discount_percent:s.discount_percent||null}))});o.success("Brouillon enregistré"),he.visit(route("pharmacy.sales.show",t.data.sale.id))}catch(t){o.error(t.response?.data?.message||"Erreur")}finally{v(!1)}};return e.jsxs(ge,{children:[e.jsx(me,{title:"Point de Vente"}),e.jsxs("div",{className:"h-[calc(100vh-64px)] flex",children:[e.jsxs("div",{className:"flex-1 flex flex-col bg-gray-50 dark:bg-slate-950",children:[e.jsx("div",{className:"p-4 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(u,{variant:"ghost",size:"sm",asChild:!0,className:"text-gray-600 dark:text-gray-300",children:e.jsxs(ue,{href:route("pharmacy.sales.index"),children:[e.jsx(Se,{className:"h-4 w-4 mr-1"}),"Retour"]})}),A&&e.jsxs("div",{className:"flex items-center bg-amber-50 dark:bg-amber-900/20 rounded-lg p-1 border border-amber-200 dark:border-amber-800",children:[e.jsxs("button",{onClick:()=>X("retail"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${f==="retail"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"}`,children:[e.jsx(be,{className:"h-4 w-4"}),"Détail"]}),e.jsxs("button",{onClick:()=>X("wholesale"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${f==="wholesale"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"}`,children:[e.jsx(p,{className:"h-4 w-4"}),"Gros"]})]}),e.jsxs("div",{className:"flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>H("list"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${T==="list"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"List Item"}),e.jsx("button",{onClick:()=>H("thumbnails"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${T==="thumbnails"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"Thumbnails"})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(ee,{type:"text",placeholder:"Search Here",value:j,onChange:t=>re(t.target.value),className:"pl-10 bg-gray-100 dark:bg-slate-800 border-0"})]}),e.jsx(u,{variant:"outline",size:"icon",className:"bg-blue-500 hover:bg-blue-600 text-white border-0",children:e.jsx(pe,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"p-3 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700 overflow-x-auto",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>V(null),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${h?"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700":"bg-amber-500 text-white"}`,children:"Tous"}),te.map(t=>e.jsx("button",{onClick:()=>V(t.id),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${h===t.id?"bg-amber-500 text-white":"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700"}`,children:t.name},t.id))]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[T==="thumbnails"?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:L.map(t=>e.jsxs("button",{onClick:()=>K(t),disabled:t.stock<1,className:`bg-white dark:bg-slate-800 rounded-xl p-3 text-center shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsxs("div",{className:"aspect-square mb-2 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover",onError:s=>{s.target.style.display="none",s.target.nextSibling.style.display="flex"}}):null,e.jsx("div",{className:`flex items-center justify-center ${t.image_url?"hidden":""}`,children:e.jsx(p,{className:"h-10 w-10 text-gray-400"})})]}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white line-clamp-2 mb-1",children:t.name}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:n(S(t))}),t.stock<5&&t.stock>0&&e.jsxs(q,{variant:"outline",className:"mt-1 text-xs text-orange-600 border-orange-300",children:["Stock: ",t.stock]}),t.stock<1&&e.jsx(q,{variant:"destructive",className:"mt-1 text-xs",children:"Rupture"})]},t.id))}):e.jsx("div",{className:"space-y-2",children:L.map(t=>e.jsxs("button",{onClick:()=>K(t),disabled:t.stock<1,className:`w-full flex items-center gap-4 bg-white dark:bg-slate-800 rounded-lg p-3 shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsx("div",{className:"w-16 h-16 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx(p,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.code})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-amber-600 dark:text-amber-400",children:n(S(t))}),A&&t.wholesale_price_amount!=null&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:f==="wholesale"?"Prix gros":`Gros: ${n(t.wholesale_price_amount)}`}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Stock: ",t.stock]})]}),e.jsx(I,{className:"h-5 w-5 text-amber-500"})]},t.id))}),L.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx(p,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Aucun produit trouvé"})]})]})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-slate-900 border-l border-gray-200 dark:border-slate-700 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(u,{variant:"outline",size:"sm",onClick:ie,disabled:r.length===0,className:"text-gray-600 dark:text-gray-300",children:[e.jsx(ye,{className:"h-4 w-4 mr-1"}),"Hold"]}),e.jsx(q,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-3 py-1",children:J}),e.jsxs(u,{variant:"outline",size:"sm",onClick:Q,className:"text-amber-600 border-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20",children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"New"]})]}),b.length>0&&e.jsx("div",{className:"flex gap-2 overflow-x-auto py-2",children:b.map((t,s)=>e.jsxs("button",{onClick:()=>de(s),className:"flex-shrink-0 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 rounded-full text-xs font-medium hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors",children:[t.orderNumber.slice(-6)," (",t.cart.length,")"]},s))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:r.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(je,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Panier vide"}),e.jsx("p",{className:"text-sm",children:"Ajoutez des produits"})]}):e.jsx("div",{className:"space-y-3",children:r.map((t,s)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-gray-50 dark:bg-slate-800 rounded-lg",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gray-200 dark:bg-slate-700 overflow-hidden flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(p,{className:"h-6 w-6 text-gray-400"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white text-sm truncate",children:t.name}),t.discount_percent>0&&e.jsxs("p",{className:"text-xs text-green-600 dark:text-green-400",children:["-",t.discount_percent,"% Discount"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{onClick:()=>Y(t.product_id,t.quantity-1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-700 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors",children:e.jsx(ke,{className:"h-3 w-3"})}),e.jsx("span",{className:"w-8 text-center font-medium text-sm",children:t.quantity}),e.jsx("button",{onClick:()=>Y(t.product_id,t.quantity+1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-700 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-600 transition-colors",children:e.jsx(I,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:n(t.price*t.quantity)}),e.jsx("button",{onClick:()=>Z(t.product_id),className:"text-red-500 hover:text-red-600 mt-1",children:e.jsx(Me,{className:"h-4 w-4"})})]})]},t.product_id))})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-slate-700 p-4 space-y-3",children:[e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-blue-600 dark:text-blue-400 hover:underline",onClick:()=>{const t=prompt("Remise (%) ?",String(x.value));t!==null&&_({type:"percent",value:parseFloat(t)||0})},children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4"}),"Add Order Discount"]}),x.value>0&&e.jsxs(q,{className:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",children:[x.value,"%"]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Sous-total ",e.jsxs("span",{className:"text-xs",children:["(",r.length," articles)"]})]}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:n(m)})]}),C>0&&e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Taxe (",C,"% TVA incluse)"]}),e.jsx("span",{children:n(B)})]}),M>0&&e.jsxs("div",{className:"flex justify-between text-green-600 dark:text-green-400",children:[e.jsx("span",{children:"Remise"}),e.jsxs("span",{children:["-",n(M)]})]})]}),e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-gray-700 dark:text-gray-300 border-t border-gray-200 dark:border-slate-700",onClick:()=>w(!0),children:[e.jsx("span",{children:"Select payment mode"}),e.jsx(ve,{className:"h-4 w-4"})]}),e.jsx("div",{className:"bg-blue-500 dark:bg-blue-600 rounded-xl p-4 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-medium",children:"Total"}),e.jsx("span",{className:"text-2xl font-bold",children:n(i)})]})}),e.jsxs(u,{onClick:()=>w(!0),disabled:r.length===0||g,className:"w-full bg-amber-500 hover:bg-amber-600 text-white py-6 text-lg font-semibold",children:[e.jsx(we,{className:"h-5 w-5 mr-2"}),g?"Traitement...":"Finaliser la vente"]})]})]})]}),le&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md mx-4 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Mode de paiement"}),e.jsx("button",{onClick:()=>w(!1),className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200",children:e.jsx(Pe,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{id:"cash",icon:_e,label:"Espèces"},{id:"card",icon:qe,label:"Carte"},{id:"mobile",icon:Re,label:"Mobile"}].map(t=>e.jsxs("button",{onClick:()=>ne(t.id),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${O===t.id?"border-amber-500 bg-amber-50 dark:bg-amber-900/20":"border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600"}`,children:[e.jsx(t.icon,{className:`h-6 w-6 ${O===t.id?"text-amber-500":"text-gray-400"}`}),e.jsx("span",{className:`text-sm font-medium ${O===t.id?"text-amber-600 dark:text-amber-400":"text-gray-600 dark:text-gray-400"}`,children:t.label})]},t.id))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Montant reçu"}),e.jsx(ee,{type:"number",step:"0.01",min:0,value:N,onChange:t=>z(t.target.value),placeholder:i.toFixed(2),className:"text-2xl h-14 text-center font-semibold"})]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[i,Math.ceil(i/10)*10,Math.ceil(i/50)*50,Math.ceil(i/100)*100].map((t,s)=>e.jsx("button",{onClick:()=>z(String(t)),className:"py-2 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:n(t)},s))}),e.jsxs("div",{className:"bg-gray-50 dark:bg-slate-800 rounded-xl p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:n(i)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Reçu"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:n(Number(N)||0)})]}),W>0&&e.jsxs("div",{className:"flex justify-between text-sm border-t border-gray-200 dark:border-slate-700 pt-2 mt-2",children:[e.jsx("span",{className:"text-green-600 dark:text-green-400",children:"Monnaie à rendre"}),e.jsx("span",{className:"font-bold text-green-600 dark:text-green-400",children:n(W)})]}),U>0&&P>0&&e.jsxs("div",{className:"flex justify-between text-sm border-t border-gray-200 dark:border-slate-700 pt-2 mt-2",children:[e.jsx("span",{className:"text-orange-600 dark:text-orange-400",children:"Reste à payer"}),e.jsx("span",{className:"font-bold text-orange-600 dark:text-orange-400",children:n(U)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Client (optionnel)"}),e.jsxs("select",{className:"w-full rounded-lg border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white",value:k,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"",children:"Sans client"}),se.map(t=>e.jsx("option",{value:t.id,children:t.full_name},t.id))]})]})]}),e.jsxs("div",{className:"p-6 bg-gray-50 dark:bg-slate-800 flex gap-3",children:[e.jsx(u,{variant:"outline",onClick:ce,disabled:g,className:"flex-1",children:"Enregistrer brouillon"}),e.jsx(u,{onClick:oe,disabled:g||r.length===0,className:"flex-1 bg-amber-500 hover:bg-amber-600 text-white",children:g?"Traitement...":"Valider la vente"})]})]})})]})}export{Ye as default};
