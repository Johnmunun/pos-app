import{u as Xe,r as s,j as e,H as Je,L as Ye,z as u,c as re,a as Ue}from"./app-BGTsh8B3.js";import{A as Ze,S as ze,b as E,m as We,V as et,P as fe,X as tt,d as rt,Y as at,_ as st,y as lt,R as nt,$ as it}from"./AppLayout-B9W2Qjn-.js";import{B as y}from"./Button-Cm51LcKk.js";import{I as H}from"./Input-LVtkliO7.js";import{B as A}from"./badge-vyxm7s9H.js";import{g as ot,f as dt}from"./currency-CAle3Gff.js";import{A as ct}from"./arrow-left-BMPE_XAu.js";import{T as mt}from"./user-cog-CgPvrrVM.js";import{X as Le,b as xt,c as ut}from"./x-Bqi0sytM.js";import"./createLucideIcon-B4miffV9.js";import"./shield-x-DRqpxde8.js";import"./Dropdown-DbeWMHj2.js";import"./transition-JR3jNvu7.js";import"./loader-circle-CIdMfzjo.js";import"./refresh-cw-CA0aJ90x.js";import"./FlashMessages-o0prhkl9.js";function gt({onClose:h,onCreated:ae,routePrefix:$="pharmacy"}){const[g,K]=s.useState(""),[G,X]=s.useState(""),[_,f]=s.useState(""),[O,i]=s.useState(!1),[z,k]=s.useState(""),se=async b=>{if(b.preventDefault(),k(""),!g.trim()){k("Nom requis");return}if(_.trim()&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(_.trim())){k("Email invalide");return}i(!0);try{const c=await re.post(route(`${$}.sales.quick-customer`),{name:g.trim(),phone:G.trim()||null,email:_.trim()||null});c.data?.success&&c.data?.customer&&(u.success("Client créé"),ae({id:String(c.data.customer.id),full_name:c.data.customer.full_name||g.trim(),phone:c.data.customer.phone||"",email:c.data.customer.email||""}))}catch(c){k(c.response?.data?.message||"Erreur")}finally{i(!1)}};return e.jsx("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/50",onClick:h,children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-xl w-full max-w-sm mx-4 p-6 shadow-xl",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Nouveau client"}),e.jsx("button",{type:"button",onClick:h,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200",children:e.jsx(Le,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Nom"}),e.jsx(H,{type:"text",value:g,onChange:b=>K(b.target.value),placeholder:"Nom du client",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Téléphone"}),e.jsx(H,{type:"text",value:G,onChange:b=>X(b.target.value),placeholder:"Optionnel",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Email"}),e.jsx(H,{type:"email",value:_,onChange:b=>f(b.target.value),placeholder:"Optionnel",className:"w-full text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),z&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:z}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(y,{type:"button",variant:"outline",onClick:h,className:"flex-1",children:"Annuler"}),e.jsx(y,{type:"submit",disabled:O,className:"flex-1",children:"Créer"})]})]})]})})}function Dt({products:h=[],categories:ae=[],customers:$=[],canUseWholesale:g=!1,cashRegisters:K=[],currency:G,currencies:X=[],exchangeRates:_={},routePrefix:f="pharmacy"}){const{shop:O}=Xe().props,i=(G??O?.currency??"CDF").toString().toUpperCase(),z=X?.length?X:O?.currencies??[],k=Object.keys(_||{}).length?_:{[i]:1},[se,b]=s.useState(i),c=se,v=(t,r)=>{if(t==null||t===0)return 0;const a=(r||i).toString().toUpperCase(),n=(c||i).toString().toUpperCase(),o=k[a]??k[i]??1,d=k[n]??1;return d===0?0:Number(t)*d/o},m=t=>dt(t,c),[le,ke]=s.useState("thumbnails"),[q,ne]=s.useState(""),[L,je]=s.useState(null),[J,Y]=s.useState(""),[l,j]=s.useState([]),[U,C]=s.useState(""),[I,Z]=s.useState(!1),[F,Ne]=s.useState([]),[ve,ie]=s.useState(xe()),[oe,R]=s.useState(!1),[de,Ie]=s.useState("cash"),[w,W]=s.useState({type:"percent",value:0}),[ee,bt]=s.useState(0),[p,we]=s.useState("retail"),[D,_e]=s.useState(0),[Ce,Se]=s.useState(null),[ce,me]=s.useState(!1),[Fe,Me]=s.useState($),Ee=s.useRef(null),qe=s.useRef(null),Re="pos_recent_product_ids",Be=5;s.useEffect(()=>{Me($)},[$]),s.useEffect(()=>{Ee.current?.focus()},[]),s.useEffect(()=>{const t=Math.min(D,Math.max(0,l.length-1));t!==D&&_e(t)},[l.length,D]);function xe(){return"A01-"+String(Math.floor(Math.random()*9e8)+1e8).padStart(10,"0")}const ue=s.useMemo(()=>{let t=h;if(L&&(t=t.filter(r=>r.category_id===L)),q.trim()){const r=q.toLowerCase();t=t.filter(a=>(a.name||"").toLowerCase().includes(r)||(a.code||"").toLowerCase().includes(r))}return t},[h,q,L]),B=t=>p==="wholesale"&&g&&t.wholesale_price_amount!=null?t.wholesale_price_amount:t.price_amount??0;s.useEffect(()=>{l.length!==0&&j(t=>t.map(r=>{const a=h.find(o=>o.id===r.product_id);if(!a)return r;const n=a.price_currency??i;return{...r,price:B(a),price_currency:n}}))},[p,i]);const[De,Ve]=s.useState(()=>{try{const t=localStorage.getItem(Re);if(!t)return[];const r=JSON.parse(t);return Array.isArray(r)?r.slice(0,12):[]}catch{return[]}}),Qe=s.useCallback(t=>{try{Ve(r=>{const a=[t,...r.filter(n=>n!==t)].slice(0,12);return localStorage.setItem(Re,JSON.stringify(a)),a})}catch{}},[]),V=t=>{const r=Number(t.stock)??0,a=!!(t.est_divisible??!0);if(r<(a?.01:1)){u.error("Stock insuffisant");return}const o=l.find(d=>d.product_id===t.id);if(o){if(o.quantity>=r){u.error("Stock insuffisant");return}j(l.map(d=>d.product_id===t.id?{...d,quantity:a?d.quantity+1:Math.min(d.quantity+1,Math.floor(r))}:d))}else{const d=t.price_currency??i;j([...l,{product_id:t.id,name:t.name,code:t.code,price:B(t),price_currency:d,quantity:1,max_stock:r,discount_percent:0,image_url:t.image_url,est_divisible:a,type_unite:t.type_unite??"UNITE"}])}Qe(t.id)},Q=(t,r)=>{const a=Number(r);if(isNaN(a))return;const n=l.find(N=>N.product_id===t);if(!n)return;const o=!!(n.est_divisible??!0);if(a<(o?.01:1)){Te(t);return}const pe=n.max_stock??0;if(a>pe){u.error("Stock insuffisant");return}const ye=o?Math.round(a*1e4)/1e4:Math.max(1,Math.floor(a));j(l.map(N=>N.product_id===t?{...N,quantity:ye}:N))},Te=t=>{j(l.filter(r=>r.product_id!==t))},Pe=()=>{j([]),W({type:"percent",value:0}),ie(xe())},S=s.useMemo(()=>l.reduce((t,r)=>{const a=r.price*r.quantity,n=r.discount_percent?a*r.discount_percent/100:0,o=a-n;return t+v(o,r.price_currency??i)},0),[l,c,k,i]),ge=s.useMemo(()=>S*ee/100,[S,ee]),te=s.useMemo(()=>w.type==="percent"?S*w.value/100:w.value,[S,w]),x=s.useMemo(()=>Math.max(0,S+ge-te),[S,ge,te]),T=Number(U)||0,be=Math.max(0,x-T),he=T>x?T-x:0,M=s.useMemo(()=>l.some(t=>t.quantity>(t.max_stock??0)),[l]),Ae=l.length>0&&!M;s.useEffect(()=>{if(oe||ce)return;const t=r=>{const a=r.target;if(a&&(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||a.tagName==="SELECT"||a.isContentEditable)&&r.key!=="p"&&r.key!=="P")return;if(r.key==="p"||r.key==="P"){l.length>0&&!M&&(R(!0),r.preventDefault());return}if(l.length===0)return;const o=l[D];if(o){if(r.key==="+"||r.key==="=")Q(o.product_id,o.quantity+1),r.preventDefault();else if(r.key==="-")Q(o.product_id,o.quantity-1),r.preventDefault();else if(r.key==="d"||r.key==="D"){const d=prompt("Remise ligne (%) ?",String(o.discount_percent||0));if(d!==null){const pe=Math.min(100,Math.max(0,parseFloat(d)||0));j(ye=>ye.map(N=>N.product_id===o.product_id?{...N,discount_percent:pe}:N))}r.preventDefault()}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[oe,ce,l,D,M]);const $e=s.useMemo(()=>{const t=z.filter(r=>r.code);return t.length>0?t:[{code:i,name:i,symbol:ot(i)}]},[z,i]),P=s.useMemo(()=>{const t=(K||[]).filter(a=>a.open_session);if(t.length===0)return null;const r=t[0];return{cash_register_id:r.id,cash_register_session_id:r.open_session.id}},[K]),He=()=>{if(l.length===0){u.error("Panier vide");return}Ne([...F,{orderNumber:ve,cart:[...l],customerId:J,discount:w,timestamp:new Date}]),j([]),Y(""),W({type:"percent",value:0}),ie(xe()),u.success("Commande mise en attente")},Ke=t=>{const r=F[t];j(r.cart),Y(r.customerId),W(r.discount),ie(r.orderNumber),Ne(F.filter((a,n)=>n!==t))},Oe=async()=>{if(l.length===0){u.error("Panier vide. Ajoutez au moins un produit.");return}if(M){u.error("Stock négatif interdit. Ajustez les quantités.");return}Z(!0);try{const r=(await re.post(route(`${f}.sales.store`),{customer_id:J||null,currency:c,sale_mode:p,lines:l.map(n=>({product_id:n.product_id,quantity:n.quantity,unit_price:v(n.price,n.price_currency??i),discount_percent:n.discount_percent||null})),...P?{cash_register_id:P.cash_register_id,cash_register_session_id:P.cash_register_session_id}:{}})).data.sale.id;await re.post(route(`${f}.sales.finalize`,r),{paid_amount:U||x});const a=x;u.success("Vente finalisée avec succès!"),R(!1),Pe(),C(""),Se({total:a}),setTimeout(()=>Se(null),2500),O?.receipt_auto_print&&window.open(route(`${f}.sales.receipt`,r),"_blank","noopener,noreferrer")}catch(t){u.error(t.response?.data?.message||"Erreur lors de la vente")}finally{Z(!1)}},Ge=async()=>{if(l.length===0){u.error("Panier vide");return}Z(!0);try{const t=await re.post(route(`${f}.sales.store`),{customer_id:J||null,currency:c,sale_mode:p,lines:l.map(r=>({product_id:r.product_id,quantity:r.quantity,unit_price:v(r.price,r.price_currency??i),discount_percent:r.discount_percent||null})),...P?{cash_register_id:P.cash_register_id,cash_register_session_id:P.cash_register_session_id}:{}});u.success("Brouillon enregistré"),Ue.visit(route(`${f}.sales.show`,t.data.sale.id))}catch(t){u.error(t.response?.data?.message||"Erreur")}finally{Z(!1)}};return e.jsxs(Ze,{fullWidth:!0,children:[e.jsx(Je,{title:"Point de Vente"}),e.jsxs("div",{className:"min-h-[calc(100vh-64px)] flex flex-col lg:flex-row relative",children:[Ce&&e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-40 bg-green-600 dark:bg-green-700 text-white py-3 px-4 text-center shadow-lg animate-in fade-in duration-300",children:[e.jsx("p",{className:"text-lg font-semibold",children:"Vente enregistrée"}),e.jsx("p",{className:"text-2xl font-bold mt-0.5",children:m(Ce.total)})]}),e.jsxs("div",{className:"w-full lg:flex-1 flex flex-col bg-gray-50 dark:bg-slate-950 min-w-0",children:[e.jsx("div",{className:"p-3 sm:p-4 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4",children:[e.jsx(y,{variant:"ghost",size:"sm",asChild:!0,className:"text-gray-600 dark:text-gray-300",children:e.jsxs(Ye,{href:route(`${f}.sales.index`),className:"inline-flex items-center gap-1.5",children:[e.jsx(ct,{className:"h-4 w-4 shrink-0"}),"Retour"]})}),$e.length>=1&&e.jsx("select",{value:c,onChange:t=>b(t.target.value),className:"h-9 rounded-md border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 text-sm font-medium px-3 w-full sm:w-auto min-w-0 sm:min-w-[100px]",title:"Devise d'affichage (conversion selon le taux configuré)",children:$e.map(t=>e.jsxs("option",{value:t.code,children:[t.code," ",t.symbol&&t.symbol!==t.code?`(${t.symbol})`:""]},t.code))}),e.jsxs("div",{className:"flex items-center bg-amber-50 dark:bg-amber-900/20 rounded-lg p-1 border border-amber-200 dark:border-amber-800",title:p==="wholesale"&&!g?"Droits vente en gros requis":"",children:[e.jsxs("button",{type:"button",onClick:()=>we("retail"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${p==="retail"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"}`,children:[e.jsx(ze,{className:"h-4 w-4"}),"Détail"]}),e.jsxs("button",{type:"button",onClick:()=>g&&we("wholesale"),disabled:!g,className:`px-3 py-1.5 rounded text-sm font-medium transition-colors flex items-center gap-1 ${p==="wholesale"?"bg-amber-500 text-white shadow-sm":"text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40"} ${g?"":"opacity-60 cursor-not-allowed"}`,title:g?"Vente en gros":"Droits vente en gros requis",children:[e.jsx(E,{className:"h-4 w-4"}),"Gros"]})]}),e.jsxs("div",{className:"flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>ke("list"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${le==="list"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"List Item"}),e.jsx("button",{onClick:()=>ke("thumbnails"),className:`px-3 py-1.5 rounded text-sm font-medium transition-colors ${le==="thumbnails"?"bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm":"text-gray-600 dark:text-gray-400"}`,children:"Thumbnails"})]}),e.jsxs("span",{className:"text-xs text-gray-400 dark:text-gray-500 hidden sm:inline shrink-0",children:["Raccourcis: ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"1"})," ventes · ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"2"})," ici · ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-gray-200 dark:bg-gray-700 font-mono text-[10px]",children:"P"})," paiement"]}),e.jsxs("div",{className:"w-full sm:flex-1 min-w-0 relative",children:[e.jsx(We,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(H,{ref:Ee,type:"text",placeholder:"Recherche ou scan code-barres",value:q,onChange:t=>{const r=t.target.value;if(ne(r),r.length>=6){const a=r.trim(),n=h.find(o=>(o.code||"").toLowerCase()===a.toLowerCase());n&&(V(n),ne(""))}},onKeyDown:t=>{if(t.key==="Enter"&&q.trim().length>=6){const r=h.find(a=>(a.code||"").toLowerCase()===q.trim().toLowerCase());r&&(V(r),ne(""),t.preventDefault())}},className:"pl-10 bg-gray-100 dark:bg-slate-800 border-0 text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400"})]}),e.jsx(y,{variant:"outline",size:"icon",className:"bg-blue-500 hover:bg-blue-600 text-white border-0",children:e.jsx(et,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"p-3 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700 overflow-x-auto",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>je(null),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${L?"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700":"bg-amber-500 text-white"}`,children:"Tous"}),ae.map(t=>e.jsx("button",{onClick:()=>je(t.id),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${L===t.id?"bg-amber-500 text-white":"bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700"}`,children:t.name},t.id))]})}),De.length>0&&e.jsxs("div",{className:"px-4 py-2 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700",children:[e.jsx("p",{className:"text-xs font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Derniers produits"}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1",children:De.map(t=>{const r=h.find(a=>a.id===t);return!r||(r.stock||0)<1?null:e.jsxs("button",{type:"button",onClick:()=>V(r),className:"flex-shrink-0 flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-left hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors",children:[r.image_url?e.jsx("img",{src:r.image_url,alt:"",className:"w-8 h-8 rounded object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded bg-gray-200 dark:bg-slate-700 flex items-center justify-center",children:e.jsx(E,{className:"h-4 w-4 text-gray-400"})}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white max-w-full sm:max-w-[100px] truncate",children:r.name}),e.jsx("span",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:m(v(B(r),r.price_currency??i))})]},t)})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[le==="thumbnails"?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4",children:ue.map(t=>e.jsxs("button",{onClick:()=>V(t),disabled:t.stock<1,className:`bg-white dark:bg-slate-800 rounded-xl p-3 text-center shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsxs("div",{className:"aspect-square mb-2 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover",onError:r=>{r.target.style.display="none",r.target.nextSibling.style.display="flex"}}):null,e.jsx("div",{className:`flex items-center justify-center ${t.image_url?"hidden":""}`,children:e.jsx(E,{className:"h-10 w-10 text-gray-400"})})]}),e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white line-clamp-2 mb-1",children:t.name}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400 font-semibold",children:m(v(B(t),t.price_currency??i))}),t.stock>0&&t.stock<Be&&e.jsx(A,{variant:"outline",className:"mt-1 text-xs text-orange-600 dark:text-orange-400 border-orange-300 dark:border-orange-600",children:"Rupture bientôt"}),t.stock<1&&e.jsx(A,{variant:"destructive",className:"mt-1 text-xs",children:"Rupture"})]},t.id))}):e.jsx("div",{className:"space-y-2",children:ue.map(t=>e.jsxs("button",{onClick:()=>V(t),disabled:t.stock<1,className:`w-full flex items-center gap-4 bg-white dark:bg-slate-800 rounded-lg p-3 shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-slate-700 ${t.stock<1?"opacity-50 cursor-not-allowed":"hover:border-amber-300 dark:hover:border-amber-500"}`,children:[e.jsx("div",{className:"w-16 h-16 rounded-lg bg-gray-100 dark:bg-slate-700 overflow-hidden flex items-center justify-center flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx(E,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.code})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-amber-600 dark:text-amber-400",children:m(v(B(t),t.price_currency??i))}),g&&t.wholesale_price_amount!=null&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:p==="wholesale"?"Prix gros":`Gros: ${m(v(t.wholesale_price_amount,t.price_currency??i))}`}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Stock: ",t.stock]})]}),e.jsx(fe,{className:"h-5 w-5 text-amber-500"})]},t.id))}),ue.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400",children:[e.jsx(E,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Aucun produit trouvé"})]})]})]}),e.jsxs("div",{className:"w-full lg:w-96 lg:min-w-[22rem] lg:max-w-md bg-white dark:bg-slate-900 border-t lg:border-t-0 lg:border-l border-gray-200 dark:border-slate-700 flex flex-col flex-shrink-0 lg:flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-slate-700",children:[e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx(A,{className:p==="wholesale"?"bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300":"bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300",children:p==="wholesale"?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-3 w-3 mr-1 inline"})," Vente en gros"]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-3 w-3 mr-1 inline"})," Vente au détail"]})})}),e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs(y,{variant:"outline",size:"sm",onClick:He,disabled:l.length===0,className:"text-gray-600 dark:text-gray-300",children:[e.jsx(tt,{className:"h-4 w-4 mr-1"}),"Hold"]}),e.jsx(A,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-3 py-1",children:ve}),e.jsxs(y,{variant:"outline",size:"sm",onClick:Pe,className:"text-amber-600 border-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/20",children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),"New"]})]}),F.length>0&&e.jsx("div",{className:"flex gap-2 overflow-x-auto py-2",children:F.map((t,r)=>e.jsxs("button",{onClick:()=>Ke(r),className:"flex-shrink-0 px-3 py-1.5 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 rounded-full text-xs font-medium hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors",children:[t.orderNumber.slice(-6)," (",t.cart.length,")"]},r))})]}),l.length>0&&e.jsxs("p",{className:"px-4 py-1 text-xs text-gray-500 dark:text-gray-400 border-b border-gray-100 dark:border-slate-800",children:["Cliquez une ligne · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"+"}),e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono ml-0.5",children:"-"})," quantité · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"D"})," remise · ",e.jsx("kbd",{className:"px-1 rounded bg-gray-200 dark:bg-gray-700 font-mono",children:"P"})," paiement"]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:l.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400",children:[e.jsx(rt,{className:"h-16 w-16 mb-4 opacity-50"}),e.jsx("p",{children:"Panier vide"}),e.jsx("p",{className:"text-sm",children:"Ajoutez des produits"})]}):e.jsx("div",{className:"space-y-3",children:l.map((t,r)=>e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg border-2 transition-colors ${r===D?"bg-amber-50 dark:bg-amber-900/20 border-amber-400 dark:border-amber-500":"bg-gray-50 dark:bg-slate-800 border-transparent"}`,onClick:()=>_e(r),children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-gray-200 dark:bg-slate-700 overflow-hidden flex-shrink-0",children:t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(E,{className:"h-6 w-6 text-gray-400"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white text-sm truncate",children:t.name}),t.discount_percent>0&&e.jsxs(A,{className:"text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 border-0",children:["Promo -",t.discount_percent,"%"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("button",{onClick:()=>Q(t.product_id,t.est_divisible!==!1?t.quantity-.5:t.quantity-1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors text-gray-700 dark:text-gray-200",children:e.jsx(at,{className:"h-3 w-3"})}),e.jsx("input",{type:"number",step:t.est_divisible!==!1?.5:1,min:t.est_divisible!==!1?.01:1,value:t.quantity,onChange:a=>{const n=parseFloat(a.target.value);Number.isNaN(n)||Q(t.product_id,n)},className:"w-14 text-center rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 text-sm font-medium tabular-nums py-1",title:t.est_divisible!==!1?"Quantité (ex. 0.5 = demi-plaquette)":"Quantité entière uniquement"}),e.jsx("button",{onClick:()=>Q(t.product_id,t.est_divisible!==!1?t.quantity+.5:t.quantity+1),className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-slate-600 flex items-center justify-center hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors text-gray-700 dark:text-gray-200",children:e.jsx(fe,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:m(v(t.price*t.quantity,t.price_currency??i))}),e.jsx("button",{onClick:()=>Te(t.product_id),className:"text-red-500 hover:text-red-600 mt-1",children:e.jsx(mt,{className:"h-4 w-4"})})]})]},t.product_id))})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-slate-700 p-4 space-y-3",children:[e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-blue-600 dark:text-blue-400 hover:underline",onClick:()=>{const t=prompt("Remise (%) ?",String(w.value));t!==null&&W({type:"percent",value:parseFloat(t)||0})},children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(st,{className:"h-4 w-4"}),"Add Order Discount"]}),w.value>0&&e.jsxs(A,{className:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",children:[w.value,"%"]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{children:["Sous-total ",e.jsxs("span",{className:"text-xs",children:["(",l.length," articles)"]})]}),e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:m(S)})]}),ee>0&&e.jsxs("div",{className:"flex justify-between text-gray-600 dark:text-gray-400",children:[e.jsxs("span",{className:"text-blue-600 dark:text-blue-400",children:["Taxe (",ee,"% TVA incluse)"]}),e.jsx("span",{children:m(ge)})]}),te>0&&e.jsxs("div",{className:"flex justify-between text-green-600 dark:text-green-400",children:[e.jsx("span",{children:"Remise"}),e.jsxs("span",{children:["-",m(te)]})]})]}),e.jsxs("button",{className:"w-full flex items-center justify-between py-2 text-sm text-gray-700 dark:text-gray-300 border-t border-gray-200 dark:border-slate-700",onClick:()=>R(!0),children:[e.jsx("span",{children:"Select payment mode"}),e.jsx(lt,{className:"h-4 w-4"})]}),e.jsx("div",{className:"bg-blue-500 dark:bg-blue-600 rounded-xl p-4 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg font-medium",children:"Total"}),e.jsx("span",{className:"text-2xl font-bold",children:m(x)})]})}),M&&e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400 font-medium",children:"Stock négatif interdit. Ajustez les quantités."}),e.jsxs(y,{onClick:()=>R(!0),disabled:l.length===0||I||M,className:"w-full bg-amber-500 hover:bg-amber-600 text-white py-6 text-lg font-semibold disabled:opacity-60",children:[e.jsx(nt,{className:"h-5 w-5 mr-2"}),I?"Traitement...":"Finaliser la vente"]})]})]})]}),oe&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onKeyDown:t=>{t.key==="Escape"&&(R(!1),t.preventDefault()),t.key==="F2"&&(C(String(Math.round(x*100)/100)),setTimeout(()=>qe.current?.focus(),0),t.preventDefault()),t.key==="Enter"&&!t.target.closest("button")&&!t.target.closest("select")&&T>=x&&Ae&&(Oe(),t.preventDefault())},children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md mx-4 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white shrink-0",children:"Mode de paiement"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 hidden sm:inline",children:"Échap · F2 tout · Entrée valider"}),e.jsx("button",{onClick:()=>R(!1),className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 shrink-0",children:e.jsx(Le,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{id:"cash",icon:it,label:"Espèces"},{id:"card",icon:xt,label:"Carte"},{id:"mobile",icon:ut,label:"Mobile"}].map(t=>e.jsxs("button",{onClick:()=>Ie(t.id),className:`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${de===t.id?"border-amber-500 bg-amber-50 dark:bg-amber-900/20":"border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600"}`,children:[e.jsx(t.icon,{className:`h-6 w-6 ${de===t.id?"text-amber-500":"text-gray-400"}`}),e.jsx("span",{className:`text-sm font-medium ${de===t.id?"text-amber-600 dark:text-amber-400":"text-gray-600 dark:text-gray-400"}`,children:t.label})]},t.id))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Montant reçu"}),e.jsx(H,{ref:qe,type:"number",step:"0.01",min:0,value:U,onChange:t=>C(t.target.value),placeholder:x.toFixed(2),className:"text-2xl h-14 text-center font-semibold text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-gray-400 bg-white dark:bg-slate-800"})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:[e.jsx("button",{type:"button",onClick:()=>C(String(Math.round(x*100)/100)),className:"py-2.5 px-3 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-sm font-medium text-amber-800 dark:text-amber-200 hover:bg-amber-200 dark:hover:bg-amber-900/50",children:"Montant exact"}),e.jsx("button",{type:"button",onClick:()=>C(String(Math.ceil(x/100)*100)),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"Arrondi 100"}),e.jsx("button",{type:"button",onClick:()=>C("50000"),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"50 000"}),e.jsx("button",{type:"button",onClick:()=>C("100000"),className:"py-2.5 px-3 bg-gray-100 dark:bg-slate-800 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-700",children:"100 000"})]}),e.jsxs("div",{className:"rounded-xl p-4 min-h-[72px] flex flex-col justify-center",children:[he>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Monnaie à rendre"}),e.jsx("p",{className:"text-3xl font-bold text-green-600 dark:text-green-400 mt-0.5",children:m(he)})]}),be>0&&T>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Reste à payer"}),e.jsx("p",{className:"text-3xl font-bold text-red-600 dark:text-red-400 mt-0.5",children:m(be)})]}),he<=0&&be<=0&&T>=x&&x>0&&e.jsx("p",{className:"text-center text-lg font-semibold text-green-600 dark:text-green-400",children:"Montant OK"})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-slate-800 rounded-xl p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:m(x)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Reçu"}),e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:m(Number(U)||0)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Client (optionnel)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{className:"flex-1 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white h-10 px-3",value:J,onChange:t=>Y(t.target.value),children:[e.jsx("option",{value:"",children:"Sans client"}),Fe.map(t=>e.jsx("option",{value:t.id,children:t.full_name},t.id))]}),e.jsx(y,{type:"button",variant:"outline",size:"sm",onClick:()=>me(!0),className:"shrink-0",title:"Créer un client",children:"+ Client"})]})]})]}),e.jsxs("div",{className:"p-6 bg-gray-50 dark:bg-slate-800 flex gap-3",children:[e.jsx(y,{variant:"outline",onClick:Ge,disabled:I||M,className:"flex-1",children:"Enregistrer brouillon"}),e.jsx(y,{onClick:Oe,disabled:I||!Ae,className:"flex-1 bg-amber-500 hover:bg-amber-600 text-white",children:I?"Traitement...":"Valider la vente"})]})]})}),ce&&e.jsx(gt,{routePrefix:f,onClose:()=>me(!1),onCreated:t=>{Me(r=>[...r,t]),Y(t.id),me(!1)}})]})}export{Dt as default};
