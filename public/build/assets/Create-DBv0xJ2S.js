import{u as P,r as n,j as e,H as U,L as g,c as z,a as R}from"./app-DtqU_Gmt.js";import{A as T,b as $,P as B}from"./AppLayout-C4K4I5xd.js";import{C as f,a as y,b as N,c as _}from"./card-Daek165Z.js";import{B as d}from"./Button-4k-pObky.js";import{I as x}from"./Input-BpgKxISb.js";import{u as H}from"./use-toast-DofxcN4x.js";import{T as Q}from"./user-cog-BQwjoD4w.js";import"./createLucideIcon-BH-qXF_i.js";import"./shield-x-Cz4kXV9c.js";import"./x-Cw-ZD_Fb.js";import"./Dropdown--z3bvfF1.js";import"./transition-DbHxI3Hw.js";import"./arrow-left-BGTcItEv.js";import"./loader-circle-DtoZnQ6b.js";import"./refresh-cw-CcjnuCLI.js";import"./FlashMessages-D-g4FpAa.js";import"./utils-CDN07tui.js";function le({auth:G,products:h=[],suppliers:C=[],routePrefix:l="pharmacy"}){const{toast:o}=H(),{shop:c}=P().props,k=c?.currency||"CDF",[m,w]=n.useState(""),[p,S]=n.useState(""),[j,L]=n.useState(k),[a,u]=n.useState([{product_id:"",product_name:"",ordered_quantity:1,unit_cost:0}]),[q,b]=n.useState(!1),D=()=>{u([...a,{product_id:"",product_name:"",ordered_quantity:1,unit_cost:0}])},E=(t,r)=>{const s=[...a];s[t]={...s[t],product_id:r.id,product_name:r.name,unit_cost:r.cost_amount??0},u(s)},v=(t,r,s)=>{const i=[...a];i[t]={...i[t],[r]:s},u(i)},F=t=>{u(a.filter((r,s)=>s!==t))},A=async t=>{if(t.preventDefault(),!m){o({title:"Sélectionnez un fournisseur",variant:"destructive"});return}const r=a.filter(s=>s.product_id&&s.ordered_quantity>0&&Number(s.unit_cost)>=0);if(r.length===0){o({title:"Ajoutez au moins une ligne avec produit et quantité",variant:"destructive"});return}b(!0);try{await z.post(route(`${l}.purchases.store`),{supplier_id:m,currency:j,expected_at:p||null,lines:r.map(s=>({product_id:s.product_id,ordered_quantity:Number(s.ordered_quantity),unit_cost:Number(s.unit_cost)}))}),o({title:"Bon de commande créé"}),R.visit(route(`${l}.purchases.index`))}catch(s){o({title:"Erreur",description:s.response?.data?.message||"Erreur",variant:"destructive"})}finally{b(!1)}};return e.jsxs(T,{header:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"font-semibold text-xl text-gray-800 dark:text-white leading-tight",children:"Nouveau bon de commande"}),e.jsx(d,{variant:"outline",asChild:!0,children:e.jsx(g,{href:route(`${l}.purchases.index`),children:"Retour"})})]}),children:[e.jsx(U,{title:"Nouveau bon de commande"}),e.jsx("div",{className:"py-12",children:e.jsx("div",{className:"max-w-4xl mx-auto sm:px-6 lg:px-8",children:e.jsxs("form",{onSubmit:A,children:[e.jsxs(f,{className:"mb-6",children:[e.jsx(y,{children:e.jsx(N,{children:"Fournisseur & dates"})}),e.jsxs(_,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Fournisseur *"}),e.jsxs("select",{className:"w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:m,onChange:t=>w(t.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Choisir..."}),C.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Date livraison prévue"}),e.jsx(x,{type:"date",value:p,onChange:t=>S(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Devise"}),e.jsx("select",{className:"w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:j,onChange:t=>L(t.target.value),children:c?.currencies&&c.currencies.length>0?c.currencies.map(t=>e.jsxs("option",{value:t.code,children:[t.code," - ",t.name]},t.code)):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"CDF",children:"CDF - Franc Congolais"}),e.jsx("option",{value:"USD",children:"USD - Dollar US"}),e.jsx("option",{value:"EUR",children:"EUR - Euro"})]})})]})]})]})]}),e.jsxs(f,{className:"mb-6",children:[e.jsx(y,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(N,{className:"flex items-center",children:[e.jsx($,{className:"h-5 w-5 mr-2"}),"Lignes"]}),e.jsxs(d,{type:"button",variant:"outline",size:"sm",onClick:D,children:[e.jsx(B,{className:"h-4 w-4 mr-1"})," Ligne"]})]})}),e.jsx(_,{children:e.jsx("div",{className:"space-y-4",children:a.map((t,r)=>e.jsxs("div",{className:"flex flex-wrap items-end gap-4 p-4 border dark:border-gray-700 rounded",children:[e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Produit"}),e.jsxs("select",{className:"w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:t.product_id,onChange:s=>{const i=h.find(I=>I.id===s.target.value);i&&E(r,i)},children:[e.jsx("option",{value:"",children:"Choisir..."}),h.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.code,")"]},s.id))]})]}),e.jsxs("div",{className:"w-24",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Qté"}),e.jsx(x,{type:"number",min:1,value:t.ordered_quantity,onChange:s=>v(r,"ordered_quantity",parseInt(s.target.value,10)||1)})]}),e.jsxs("div",{className:"w-28",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Prix d'achat"}),e.jsx(x,{type:"number",step:"0.01",min:0,value:t.unit_cost,onChange:s=>v(r,"unit_cost",parseFloat(s.target.value)||0)})]}),e.jsx(d,{type:"button",variant:"ghost",size:"sm",onClick:()=>F(r),disabled:a.length<=1,children:e.jsx(Q,{className:"h-4 w-4 text-red-500"})})]},r))})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(d,{type:"button",variant:"outline",asChild:!0,children:e.jsx(g,{href:route(`${l}.purchases.index`),children:"Annuler"})}),e.jsx(d,{type:"submit",disabled:q,children:"Enregistrer le bon de commande"})]})]})})})]})}export{le as default};
