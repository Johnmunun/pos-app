import{r as c,j as e,z as p,c as q}from"./app-3PKVeuQh.js";import{B as v}from"./Button-RC9FN5z3.js";import{I as y}from"./Input-5gvkn2nv.js";import{t as D,b as U,P as A,h as B}from"./AppLayout-DSrKCpOy.js";import{X as I}from"./x-YL0zAneP.js";import{T as M}from"./user-cog-nVqfHm0b.js";function J({isOpen:b,onClose:m,purchaseOrder:d=null,suppliers:N=[],products:_=[],currency:x="USD",onSuccess:P}){const u=!!d,[s,n]=c.useState({supplier_id:"",expected_at:"",currency:x,notes:""}),[l,o]=c.useState([{product_id:"",product_name:"",ordered_quantity:1,unit_cost:0}]),[h,g]=c.useState({}),[f,k]=c.useState(!1),[j,w]=c.useState("");c.useEffect(()=>{b&&(d?(n({supplier_id:d.supplier_id||"",expected_at:d.expected_at?d.expected_at.split("T")[0]:"",currency:d.currency||x,notes:d.notes||""}),d.lines&&d.lines.length>0&&o(d.lines.map(t=>({product_id:t.product_id,product_name:t.product_name,ordered_quantity:t.ordered_quantity,unit_cost:t.unit_cost})))):(n({supplier_id:"",expected_at:"",currency:x,notes:""}),o([{product_id:"",product_name:"",ordered_quantity:1,unit_cost:0}])),g({}),w(""))},[b,d,x]);const z=()=>{o([...l,{product_id:"",product_name:"",ordered_quantity:1,unit_cost:0}])},F=(t,a)=>{const r=[...l];r[t]={...r[t],product_id:a.id,product_name:a.name,unit_cost:a.cost_amount??0},o(r)},C=(t,a,r)=>{const i=[...l];i[t]={...i[t],[a]:r},o(i)},L=t=>{l.length>1&&o(l.filter((a,r)=>r!==t))},E=()=>l.reduce((t,a)=>t+Number(a.ordered_quantity)*Number(a.unit_cost),0),T=_.filter(t=>{if(!j.trim())return!0;const a=j.toLowerCase();return(t.name||"").toLowerCase().includes(a)||(t.code||"").toLowerCase().includes(a)}),S=async t=>{if(t.preventDefault(),!s.supplier_id){g({supplier_id:"Veuillez sélectionner un fournisseur"});return}const a=l.filter(r=>r.product_id&&r.ordered_quantity>0);if(a.length===0){p.error("Ajoutez au moins une ligne avec un produit");return}k(!0),g({});try{const r={supplier_id:s.supplier_id,currency:s.currency,expected_at:s.expected_at||null,notes:s.notes||null,lines:a.map(i=>({product_id:i.product_id,ordered_quantity:Number(i.ordered_quantity),unit_cost:Number(i.unit_cost)}))};u?(await q.put(route("pharmacy.purchases.update",d.id),r),p.success("Bon de commande modifié avec succès")):(await q.post(route("pharmacy.purchases.store"),r),p.success("Bon de commande créé avec succès")),P?.(),m()}catch(r){r.response?.data?.errors?g(r.response.data.errors):p.error(r.response?.data?.message||"Une erreur est survenue")}finally{k(!1)}};return b?(N.find(t=>t.id===s.supplier_id),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40 transition-opacity",onClick:m}),e.jsx("div",{className:"fixed inset-y-0 right-0 z-50 w-full max-w-2xl bg-white dark:bg-gray-800 shadow-xl transform transition-transform",children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-900",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center",children:e.jsx(D,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:u?"Modifier le bon de commande":"Nouveau bon de commande"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:u?`#${d.id.slice(0,8)}`:"Remplissez les informations ci-dessous"})]})]}),e.jsx("button",{onClick:m,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:e.jsx(I,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("form",{onSubmit:S,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/30 rounded-lg p-4 space-y-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2",children:[e.jsx(D,{className:"h-4 w-4"}),"Informations générales"]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:["Fournisseur ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{className:`w-full rounded-lg border ${h.supplier_id?"border-red-500":"border-gray-300 dark:border-gray-600"} bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-2 focus:ring-2 focus:ring-primary`,value:s.supplier_id,onChange:t=>n({...s,supplier_id:t.target.value}),disabled:u&&d?.status!=="DRAFT",children:[e.jsx("option",{value:"",children:"Sélectionner un fournisseur..."}),N.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),h.supplier_id&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:h.supplier_id})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Date de livraison prévue"}),e.jsx(y,{type:"date",value:s.expected_at,onChange:t=>n({...s,expected_at:t.target.value}),className:"bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Devise"}),e.jsxs("select",{className:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-2 focus:ring-2 focus:ring-primary",value:s.currency,onChange:t=>n({...s,currency:t.target.value}),children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"CDF",children:"CDF"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Notes (optionnel)"}),e.jsx("textarea",{className:"w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-2 focus:ring-2 focus:ring-primary resize-none",rows:2,placeholder:"Notes ou instructions...",value:s.notes,onChange:t=>n({...s,notes:t.target.value})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"Produits à commander"]}),e.jsxs(v,{type:"button",variant:"outline",size:"sm",onClick:z,children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),"Ajouter une ligne"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(B,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(y,{type:"text",placeholder:"Rechercher un produit...",value:j,onChange:t=>w(t.target.value),className:"pl-10 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"})]}),e.jsx("div",{className:"space-y-3",children:l.map((t,a)=>e.jsx("div",{className:"bg-white dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 p-4",children:e.jsxs("div",{className:"flex flex-wrap items-end gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("label",{className:"block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400",children:"Produit"}),e.jsxs("select",{className:"w-full rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-2 text-sm",value:t.product_id,onChange:r=>{const i=_.find(R=>R.id===r.target.value);i&&F(a,i)},children:[e.jsx("option",{value:"",children:"Sélectionner..."}),T.map(r=>e.jsxs("option",{value:r.id,children:[r.name," (",r.code,")"]},r.id))]})]}),e.jsxs("div",{className:"w-24",children:[e.jsx("label",{className:"block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400",children:"Quantité"}),e.jsx(y,{type:"number",min:1,value:t.ordered_quantity,onChange:r=>C(a,"ordered_quantity",parseInt(r.target.value,10)||1),className:"text-sm"})]}),e.jsxs("div",{className:"w-28",children:[e.jsx("label",{className:"block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400",children:"Prix unitaire"}),e.jsx(y,{type:"number",step:"0.01",min:0,value:t.unit_cost,onChange:r=>C(a,"unit_cost",parseFloat(r.target.value)||0),className:"text-sm"})]}),e.jsxs("div",{className:"w-24 text-right",children:[e.jsx("label",{className:"block text-xs font-medium mb-1 text-gray-500 dark:text-gray-400",children:"Total"}),e.jsx("p",{className:"py-2 font-semibold text-gray-900 dark:text-gray-100",children:(Number(t.ordered_quantity)*Number(t.unit_cost)).toFixed(2)})]}),e.jsx("button",{type:"button",onClick:()=>L(a),disabled:l.length<=1,className:"p-2 text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(M,{className:"h-4 w-4"})})]})},a))})]})]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Total de la commande"}),e.jsxs("span",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:[s.currency," ",E().toFixed(2)]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(v,{type:"button",variant:"outline",onClick:m,className:"flex-1",disabled:f,children:"Annuler"}),e.jsx(v,{type:"submit",onClick:S,className:"flex-1",disabled:f,children:f?"Enregistrement...":u?"Mettre à jour":"Créer le bon"})]})]})]})})]})):null}export{J as P};
