import{u as K,r as m,n as l,b as Q,j as e,H as Y,a as M,c as Z}from"./app-DtqU_Gmt.js";import{A as ee,P as re}from"./AppLayout-C4K4I5xd.js";import{D as se}from"./Drawer-Dy6JDRVK.js";import{X as te}from"./x-Cw-ZD_Fb.js";import{C as ae}from"./user-cog-BQwjoD4w.js";import"./createLucideIcon-BH-qXF_i.js";import"./shield-x-Cz4kXV9c.js";import"./Dropdown--z3bvfF1.js";import"./transition-DbHxI3Hw.js";import"./arrow-left-BGTcItEv.js";import"./loader-circle-DtoZnQ6b.js";import"./refresh-cw-CcjnuCLI.js";import"./FlashMessages-D-g4FpAa.js";function be(){const{roles:A,search:z,allPermissions:v,flash:y}=K().props,[P,H]=m.useState(z||""),[b,R]=m.useState(""),[D,N]=m.useState(null),[V,f]=m.useState(!1),[p,k]=m.useState(null),[w,C]=m.useState(!1),[q,E]=m.useState(!1);m.useEffect(()=>{y?.success&&l.success(y.success),y?.error&&l.error(y.error)},[y]);const{data:i,setData:d,post:I,put:L,processing:O,errors:g,reset:_}=Q({name:"",description:"",permissions:[]}),B=r=>{r.preventDefault(),M.get(route("admin.access.roles"),{search:P},{preserveState:!0,preserveScroll:!0})},F=r=>{M.delete(route("admin.access.roles.delete",r),{preserveScroll:!0,onSuccess:()=>N(null)})},U=()=>{_(),k(null),C(!1),f(!0)},W=async r=>{E(!0),f(!0);try{const t=await Z.get(route("admin.access.roles.get",r)),s=t.data.role;k(s),C(t.data.isRootRole);let o=[];Array.isArray(s.permissions)?o=s.permissions.map(a=>a.id||a):s.permissions&&(o=Object.values(s.permissions).map(a=>a.id||a)),d({name:s.name||"",description:s.description||"",permissions:o})}catch(t){console.error("Error loading role:",t),f(!1)}finally{E(!1)}},h=()=>{f(!1),k(null),C(!1),R(""),_()},$=m.useMemo(()=>{const r=Object.values(v||{}).flat(),t=Array.isArray(i.permissions)?i.permissions.map(s=>typeof s=="number"?s:parseInt(s,10)).filter(s=>!isNaN(s)):[];return r.filter(s=>{const o=typeof s.id=="number"?s.id:parseInt(s.id,10);return!isNaN(o)&&t.includes(o)})},[i.permissions,v]),X=r=>{if(r.preventDefault(),r.stopPropagation(),!i.name.trim()){l.error("Le nom du rôle est obligatoire");return}let t=Array.isArray(i.permissions)?i.permissions:[];if(t=t.map(s=>typeof s=="number"?s:parseInt(s,10)).filter(s=>!isNaN(s)),t.length===0){const s=()=>{d("permissions",t),d("name",i.name.trim()),d("description",i.description||""),p?L(route("admin.access.roles.update",p.id),{preserveScroll:!0,onSuccess:()=>{h(),l.success("Rôle mis à jour avec succès")},onError:o=>{console.error("Erreur lors de la mise à jour:",o),l.error("Erreur lors de la mise à jour du rôle")}}):I(route("admin.access.roles.store"),{preserveScroll:!0,onSuccess:()=>{h(),l.success("Rôle créé avec succès")},onError:o=>{console.error("Erreur lors de la création:",o),l.error("Erreur lors de la création du rôle")}})};l.custom(o=>e.jsx("div",{className:`${o.visible?"animate-enter":"animate-leave"} max-w-md w-full bg-white dark:bg-gray-800 shadow-lg rounded-lg pointer-events-auto flex ring-1 ring-black ring-opacity-5`,children:e.jsxs("div",{className:"flex-1 w-0 p-4",children:[e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ae,{className:"h-6 w-6 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{className:"ml-3 flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Aucune permission sélectionnée"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:"Voulez-vous vraiment créer un rôle sans permission ?"})]})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx("button",{onClick:()=>{l.dismiss(o.id),s()},className:"flex-1 bg-amber-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-700 transition",children:"Continuer"}),e.jsx("button",{onClick:()=>l.dismiss(o.id),className:"flex-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition",children:"Annuler"})]})]})}),{duration:1/0});return}d("permissions",t),d("name",i.name.trim()),d("description",i.description||""),p?L(route("admin.access.roles.update",p.id),{preserveScroll:!0,onSuccess:()=>{h(),l.success("Rôle mis à jour avec succès")},onError:s=>{console.error("Erreur lors de la mise à jour:",s),console.error("Données envoyées:",{name:i.name,permissions:t}),l.error("Erreur lors de la mise à jour du rôle")}}):I(route("admin.access.roles.store"),{preserveScroll:!0,onSuccess:()=>{h(),l.success("Rôle créé avec succès")},onError:s=>{console.error("Erreur lors de la création:",s),console.error("Données envoyées:",{name:i.name,permissions:t}),l.error("Erreur lors de la création du rôle")}})},S=r=>{console.log("togglePermission appelé avec:",r,"Type:",typeof r),console.log("data.permissions avant:",i.permissions);const t=typeof r=="number"?r:parseInt(r,10);if(isNaN(t)){console.error("ID de permission invalide:",r);return}const s=Array.isArray(i.permissions)?i.permissions.map(a=>typeof a=="number"?a:parseInt(a,10)).filter(a=>!isNaN(a)):[];console.log("Permissions actuelles normalisées:",s),console.log("ID à toggle:",t,"Est inclus?",s.includes(t));const o=s.includes(t)?s.filter(a=>a!==t):[...s,t];console.log("Nouvelles permissions:",o),d("permissions",o),setTimeout(()=>{console.log("data.permissions après setData:",i.permissions)},100)},G=r=>{const t=r.map(a=>{const x=typeof a.id=="number"?a.id:parseInt(a.id,10);return isNaN(x)?null:x}).filter(a=>a!==null),s=Array.isArray(i.permissions)?i.permissions.map(a=>typeof a=="number"?a:parseInt(a,10)):[],o=t.every(a=>s.includes(a));d("permissions",a=>{const x=Array.isArray(a)?a:[];if(o)return x.filter(u=>!t.includes(u));{const u=[...x];return t.forEach(n=>{u.includes(n)||u.push(n)}),u}})};return e.jsxs(ee,{header:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold leading-tight text-gray-900 dark:text-white",children:"Gestion des Rôles"}),e.jsxs("button",{onClick:U,className:"inline-flex items-center gap-2 px-3 sm:px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-medium rounded-lg transition-colors shrink-0","aria-label":"Créer un rôle",children:[e.jsx(re,{className:"w-5 h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Créer un rôle"})]})]}),children:[e.jsx(Y,{title:"Gestion des Rôles"}),e.jsx("div",{className:"py-6",children:e.jsxs("div",{className:"mx-auto max-w-7xl px-4 sm:px-6 lg:px-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("form",{onSubmit:B,className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",value:P,onChange:r=>H(r.target.value),placeholder:"Rechercher un rôle...",className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"})}),e.jsx("button",{type:"submit",className:"px-6 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium",children:"Rechercher"})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Nom"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Utilisateurs"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Permissions"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Statut"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:A.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-6 py-8 text-center text-gray-500 dark:text-gray-400",children:"Aucun rôle trouvé"})}):A.map(r=>{const t=r.name==="ROOT"&&r.tenant_id===null;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:r.name}),t&&e.jsx("span",{className:"px-2 py-1 text-xs font-semibold bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300 rounded",children:"ROOT"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 line-clamp-2",children:r.description||"—"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:r.users_count||0})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:r.permissions_count||0})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${r.is_active?"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300":"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300"}`,children:r.is_active?"Actif":"Inactif"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>W(r.id),className:"text-amber-600 dark:text-amber-400 hover:text-amber-900 dark:hover:text-amber-300",children:"Éditer"}),!t&&e.jsx("button",{onClick:()=>N(r.id),className:"text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300",children:"Supprimer"})]})})]},r.id)})})]})})})]})}),e.jsx(se,{isOpen:V,onClose:h,title:p?"Éditer le rôle":"Créer un rôle",size:"lg",children:q?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600"})}):e.jsxs("form",{onSubmit:X,className:"space-y-6",noValidate:!0,children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Informations du rôle"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Nom du rôle *"}),e.jsx("input",{type:"text",value:i.name,onChange:r=>d("name",r.target.value),disabled:w,className:`w-full px-4 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent ${g.name?"border-red-500":"border-gray-300 dark:border-gray-600"} ${w?"opacity-50 cursor-not-allowed":""}`,required:!0}),g.name&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:g.name}),w&&e.jsx("p",{className:"mt-1 text-sm text-amber-600 dark:text-amber-400",children:"Le nom du rôle ROOT ne peut pas être modifié"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Description"}),e.jsx("textarea",{value:i.description,onChange:r=>d("description",r.target.value),rows:3,className:`w-full px-4 py-2 border rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent ${g.description?"border-red-500":"border-gray-300 dark:border-gray-600"}`}),g.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:g.description})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Permissions"}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:[Array.isArray(i.permissions)?i.permissions.length:0," permission",(Array.isArray(i.permissions)?i.permissions.length:0)>1?"s":""," sélectionnée",(Array.isArray(i.permissions)?i.permissions.length:0)>1?"s":""]})]}),$.length>0&&e.jsxs("div",{className:"mb-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Permissions sélectionnées :"}),e.jsx("div",{className:"flex flex-wrap gap-2 max-h-32 overflow-y-auto",children:$.map(r=>e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300 rounded-lg text-sm font-medium border border-amber-200 dark:border-amber-800",children:[e.jsx("span",{children:r.code}),e.jsx("button",{type:"button",onClick:()=>S(r.id),className:"hover:bg-amber-200 dark:hover:bg-amber-800 rounded-full p-0.5 transition-colors","aria-label":`Retirer ${r.code}`,children:e.jsx(te,{className:"w-3.5 h-3.5"})})]},r.id))})]}),e.jsx("div",{className:"mb-4",children:e.jsx("input",{type:"text",value:b,onChange:r=>R(r.target.value),placeholder:"Rechercher une permission...",className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"})}),e.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:Object.entries(v||{}).filter(([r,t])=>{if(!b.trim())return!0;const s=b.toLowerCase();return r.toLowerCase().includes(s)||t.some(o=>o.code.toLowerCase().includes(s)||o.description&&o.description.toLowerCase().includes(s))}).map(([r,t])=>{const s=t.filter(n=>{if(!b.trim())return!0;const j=b.toLowerCase();return n.code.toLowerCase().includes(j)||n.description&&n.description.toLowerCase().includes(j)});if(s.length===0)return null;const o=Array.isArray(i.permissions)?i.permissions:[],a=s.map(n=>n.id),x=a.every(n=>o.includes(n)),u=a.some(n=>o.includes(n));return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900 px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800",onClick:n=>{n.stopPropagation(),G(s)},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:x,ref:n=>{n&&(n.indeterminate=u&&!x)},onChange:n=>{n.stopPropagation(),G(s)},className:"w-4 h-4 text-amber-600 rounded focus:ring-amber-500 cursor-pointer"}),e.jsx("h4",{className:"font-medium text-gray-900 dark:text-white",children:r||"Sans groupe"})]}),e.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:[s.length," permission",s.length>1?"s":""]})]}),e.jsx("div",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:s.map(n=>{const j=Array.isArray(i.permissions)?i.permissions.map(c=>typeof c=="number"?c:parseInt(c,10)):[],T=typeof n.id=="number"?n.id:parseInt(n.id,10),J=!isNaN(T)&&j.includes(T);return e.jsxs("label",{className:"flex items-center gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer",onClick:c=>{c.stopPropagation(),S(n.id)},children:[e.jsx("input",{type:"checkbox",checked:J,onChange:c=>{c.stopPropagation(),c.preventDefault(),S(n.id)},onClick:c=>{c.stopPropagation()},className:"w-4 h-4 text-amber-600 rounded focus:ring-amber-500 cursor-pointer"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:n.code}),n.description&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:n.description})]})]},n.id)})})]},r)}).filter(Boolean)})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:h,className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:O,className:"px-4 py-2 text-sm font-medium text-white bg-amber-600 rounded-lg hover:bg-amber-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors",children:O?"Enregistrement...":p?"Mettre à jour":"Créer"})]})]})}),D&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Confirmer la suppression"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-6",children:"Êtes-vous sûr de vouloir supprimer ce rôle ? Cette action est irréversible."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>N(null),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:"Annuler"}),e.jsx("button",{onClick:()=>F(D),className:"px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors",children:"Supprimer"})]})]})})]})}export{be as default};
