import{r as l,j as e,H as le,L as de,c as ce,a as f}from"./app-Bu58nmqp.js";import{A as ne,b as P,s as ie,f as oe,q as xe,u as T,o as me,C as z,e as ge,v as V,w as E,g as he,i as ue,x as pe,n as be}from"./AppLayout-PYzm33Di.js";import{C as c,c as n,a as L,b as M}from"./card-DoR82Obt.js";import{B as d}from"./Button-CJzVzbMf.js";import{I as B}from"./Input-B1xyFs7T.js";import"./Label-BUXOAy6-.js";import{u as fe}from"./use-toast-DINbgNCQ.js";import{C as j}from"./x-BNg5u3GU.js";import{A as je}from"./arrow-left-DSvgm0i3.js";import{C as ye}from"./loader-circle-BgO0_QPs.js";import"./createLucideIcon-D31lZ7X_.js";import"./shield-x-Be2eaKBY.js";import"./user-cog-DOLB-E56.js";import"./Dropdown-BckUvWPZ.js";import"./transition-Dwpb1-fu.js";import"./refresh-cw-DMClxRp8.js";import"./FlashMessages-Ce1oH_d3.js";const O={draft:{label:"Brouillon",color:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",icon:be},in_progress:{label:"En cours",color:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",icon:ye},validated:{label:"Validé",color:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",icon:j},cancelled:{label:"Annulé",color:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",icon:z}};function He({inventory:r,items:i,stats:ke,availableProducts:Ne=[],categories:H=[],permissions:m}){const{toast:y}=fe(),[g,$]=l.useState(""),[h,F]=l.useState(""),[k,Q]=l.useState(!1),[o,R]=l.useState(()=>{const t={};return i.forEach(a=>{t[a.product_id]=a.counted_quantity??""}),t}),[_,S]=l.useState(!1),[D,we]=l.useState([]),[U,N]=l.useState(!1),[W,w]=l.useState(!1),u=m?.edit&&["draft","in_progress"].includes(r.status),X=m?.validate&&r.status==="in_progress",G=m?.cancel&&r.status!=="validated",v=r.status==="draft",J=m?.view,I=l.useMemo(()=>i.filter(t=>{if(g){const a=g.toLowerCase();if(!t.product_name.toLowerCase().includes(a)&&!t.product_code.toLowerCase().includes(a))return!1}return!(h&&t.category_name!==h||k&&t.difference===0)}),[i,g,h,k]),x=l.useMemo(()=>{let t=0,a=0,s=0,C=0;return i.forEach(A=>{const p=o[A.product_id];if(p!==""&&p!==null&&p!==void 0){s++;const b=parseInt(p,10)-A.system_quantity;b>0?(t+=b,C++):b<0&&(a+=Math.abs(b),C++)}}),{total_items:i.length,counted_items:s,items_with_difference:C,total_positive:t,total_negative:a}},[i,o]),K=(t,a)=>{R(s=>({...s,[t]:a}))},Y=async()=>{S(!0);try{const t=Object.entries(o).filter(([a,s])=>s!==""&&s!==null&&s!==void 0).map(([a,s])=>({product_id:a,counted_quantity:parseInt(s,10)}));if(t.length===0){y({title:"Attention",description:"Aucune quantité à sauvegarder.",variant:"warning"});return}await ce.post(route("pharmacy.inventories.counts",r.id),{counts:t}),y({title:"Succès",description:"Quantités sauvegardées avec succès."}),f.reload()}catch(t){y({title:"Erreur",description:t.response?.data?.message||"Erreur lors de la sauvegarde.",variant:"destructive"})}finally{S(!1)}},q=()=>{const t=D.length>0?D:null;f.post(route("pharmacy.inventories.start",r.id),{product_ids:t})},Z=()=>N(!0),ee=()=>{N(!1),f.post(route("pharmacy.inventories.validate",r.id))},te=()=>w(!0),ae=()=>{w(!1),f.post(route("pharmacy.inventories.cancel",r.id))},re=t=>{const a=o[t.product_id];if(a===""||a===null||a===void 0)return e.jsx(pe,{className:"h-4 w-4 text-gray-400"});const s=parseInt(a,10)-t.system_quantity;return s===0?e.jsx("span",{className:"text-gray-500",children:"0"}):s>0?e.jsxs("span",{className:"flex items-center text-green-600 dark:text-green-400 font-medium",children:[e.jsx(V,{className:"h-4 w-4 mr-1"}),"+",s]}):e.jsxs("span",{className:"flex items-center text-red-600 dark:text-red-400 font-medium",children:[e.jsx(E,{className:"h-4 w-4 mr-1"}),s]})},se=t=>{const a=O[t]||O.draft,s=a.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium ${a.color}`,children:[e.jsx(s,{className:"h-4 w-4"}),a.label]})};return e.jsxs(ne,{header:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(de,{href:route("pharmacy.inventories.index"),className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors",children:e.jsx(je,{className:"h-5 w-5 text-gray-600 dark:text-gray-300"})}),e.jsxs("h2",{className:"font-semibold text-xl text-gray-800 dark:text-gray-100 leading-tight",children:["Inventaire ",r.reference]})]}),children:[e.jsx(le,{title:`Inventaire ${r.reference}`}),e.jsx("div",{className:"py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:[e.jsx(c,{className:"mb-6 bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsx(n,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:r.reference}),se(r.status)]}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400",children:[r.depot&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(P,{className:"h-4 w-4 text-amber-500"}),"Dépôt : ",r.depot.name,r.depot.code&&` (${r.depot.code})`]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"h-4 w-4"}),"Créé le ",r.created_at]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:"h-4 w-4"}),"Par ",r.creator?.name??"Inconnu"]}),r.validated_at&&e.jsxs("span",{className:"flex items-center gap-1 text-green-600 dark:text-green-400",children:[e.jsx(j,{className:"h-4 w-4"}),"Validé le ",r.validated_at]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[J&&e.jsxs(d,{type:"button",variant:"outline",onClick:()=>window.open(route("pharmacy.exports.inventories.pdf",r.id),"_blank"),className:"border-gray-300 dark:border-slate-600",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"PDF"]}),v&&u&&e.jsxs(d,{onClick:q,className:"bg-blue-500 hover:bg-blue-600 text-white",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Démarrer"]}),u&&!v&&e.jsxs(d,{onClick:Y,disabled:_,className:"bg-amber-500 hover:bg-amber-600 text-white",children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),_?"Sauvegarde...":"Sauvegarder"]}),X&&e.jsxs(d,{onClick:Z,className:"bg-green-500 hover:bg-green-600 text-white",children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"Valider"]}),G&&e.jsxs(d,{onClick:te,variant:"outline",className:"border-red-300 text-red-600 hover:bg-red-50 dark:border-red-800 dark:text-red-400 dark:hover:bg-red-900/20",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Annuler"]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-6",children:[e.jsx(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(n,{className:"p-4 text-center",children:[e.jsx(P,{className:"h-6 w-6 text-blue-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:x.total_items}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Produits"})]})}),e.jsx(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(n,{className:"p-4 text-center",children:[e.jsx(j,{className:"h-6 w-6 text-green-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:x.counted_items}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Comptés"})]})}),e.jsx(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(n,{className:"p-4 text-center",children:[e.jsx(ge,{className:"h-6 w-6 text-orange-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:x.items_with_difference}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Écarts"})]})}),e.jsx(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(n,{className:"p-4 text-center",children:[e.jsx(V,{className:"h-6 w-6 text-green-500 mx-auto mb-2"}),e.jsxs("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:["+",x.total_positive]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Surplus"})]})}),e.jsx(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:e.jsxs(n,{className:"p-4 text-center",children:[e.jsx(E,{className:"h-6 w-6 text-red-500 mx-auto mb-2"}),e.jsxs("div",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:["-",x.total_negative]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Manquants"})]})})]}),v?e.jsxs(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:[e.jsx(L,{children:e.jsx(M,{className:"text-gray-900 dark:text-white",children:"Démarrer l'inventaire"})}),e.jsxs(n,{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:`Cliquez sur "Démarrer" pour créer le snapshot du stock actuel. Tous les produits actifs seront inclus dans l'inventaire.`}),u&&e.jsxs(d,{onClick:q,className:"bg-blue-500 hover:bg-blue-600 text-white",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Démarrer l'inventaire"]})]})]}):e.jsxs(c,{className:"bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700",children:[e.jsx(L,{children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs(M,{className:"flex items-center text-gray-900 dark:text-white",children:[e.jsx(he,{className:"h-5 w-5 mr-2 text-amber-500"}),"Produits à inventorier"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx(B,{placeholder:"Rechercher...",value:g,onChange:t=>$(t.target.value),className:"pl-9 w-48 bg-white dark:bg-slate-800 border-gray-300 dark:border-slate-600 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400"})]}),e.jsxs("select",{value:h,onChange:t=>F(t.target.value),className:"h-10 rounded-md border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 px-3 focus:outline-none focus:ring-2 focus:ring-amber-500",children:[e.jsx("option",{value:"",children:"Toutes catégories"}),H.map(t=>e.jsx("option",{value:t.name,children:t.name},t.id))]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:t=>Q(t.target.checked),className:"rounded border-gray-300 dark:border-slate-600 text-amber-500 focus:ring-amber-500"}),"Écarts uniquement"]})]})]})}),e.jsxs(n,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-slate-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-slate-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Produit"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Catégorie"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Stock système"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Qté comptée"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Écart"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700",children:I.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-slate-800",children:[e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.product_name}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.product_code})]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400",children:t.category_name||"-"}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.system_quantity})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:u?e.jsx(B,{type:"number",min:"0",value:o[t.product_id]??"",onChange:a=>K(t.product_id,a.target.value),className:"w-24 mx-auto text-center bg-white dark:bg-slate-800 border-gray-300 dark:border-slate-600 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400",placeholder:"—"}):e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.counted_quantity??"—"})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-center",children:re(t)})]},t.id))})]})}),I.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"Aucun produit ne correspond aux filtres"})]})]})]})}),U&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-xl max-w-md w-full mx-4 p-6 border border-gray-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Valider l'inventaire"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-6",children:"Êtes-vous sûr de vouloir valider cet inventaire ? Les ajustements de stock seront appliqués."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>N(!1),className:"border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300",children:"Annuler"}),e.jsx(d,{type:"button",onClick:ee,className:"bg-green-500 hover:bg-green-600 text-white",children:"Valider"})]})]})}),W&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-xl max-w-md w-full mx-4 p-6 border border-gray-200 dark:border-slate-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Annuler l'inventaire"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-6",children:"Êtes-vous sûr de vouloir annuler cet inventaire ?"}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx(d,{type:"button",variant:"outline",onClick:()=>w(!1),className:"border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300",children:"Non"}),e.jsx(d,{type:"button",onClick:ae,variant:"outline",className:"border-red-300 text-red-600 hover:bg-red-50 dark:border-red-800 dark:text-red-400 dark:hover:bg-red-900/20",children:"Oui, annuler"})]})]})})]})}export{He as default};
